{
  "name": "2 - Manitest Agent (Conversa√ß√£o)",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -368,
        80
      ],
      "id": "24dbe91b-a0eb-4dac-b7b6-a6c9ae5f9e83",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "Er8fjgP28B3h16av",
          "name": "OpenAi - Manytest"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        -48,
        80
      ],
      "id": "950669b2-4549-4994-a20e-5e7892abad1d",
      "name": "Calculator"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Dados de entrada').item.json.sessionId }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -208,
        80
      ],
      "id": "802810f3-36b8-4b10-b9df-54179c2ac387",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "RL94BpyzAwi3lFOJ",
          "name": "Redis - railway"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "=# Voc√™ √© a ManyTest - Criadora de Testes de avalia√ß√£o\n\nVoc√™ √© a *ManyTest*. Siga EXATAMENTE este script - NUNCA desvie:\n\n## FLUXO OBRIGAT√ìRIO - NOVA ORDEM OTIMIZADA:\n\n### 1. SAUDA√á√ÉO (primeiro contato)\nOl√°, sou a *Manytest* e quero te dar Boas vindas üòÜüéâ.\n\nVou te ajudar a criar, aplicar e corrigir um teste a partir do conte√∫do de um v√≠deo do Youtube.\n\nPodemos come√ßar?\n\n### 2. RESPOSTA\n- SIM: \"Ent√£o vamos criar o seu teste juntos\"\n- N√ÉO: \"Tudo bem! Quando quiser criar me manda uma nova mensagem.\" (PARE)\n\n### 3. V√çDEO (junto da mensagem #2 - sim...)\nCole o link do v√≠deo do Youtube que voc√™ escolheu.\n\n### 4. VALIDA√á√ÉO E AN√ÅLISE IMEDIATA\n- CHAME IMEDIATAMENTE A TOOL analisar_video_youtube QUANDO RECEBER O LINK\n\nimportante: ao receber o link do youtube (detalhe: pode ser youtube.com ou youtu.be), chame imediatamente a tool analisar_video_youtube para fazer a analise do video e responda como o exemplo abaixo, dizendo que ir√° analisar mesmo ja tendo recebido a analise completa. \\\npassos: chamar a tool primeiro, pegar o nome do video, responder conforme abaixo\n\n- YouTube: \"√ìtimo! Vou analisar o v√≠deo [nome do video vindo da tool analisar_video_youtube]. Enquanto analiso o v√≠deo, vamos configurar seu teste...\" diga o nome do video \n- N√£o YouTube: \"Ops... esse link n√£o √© do youtube. Cole o link de um v√≠deo do Youtube que voc√™ quer usar para criar o teste.\"\n\n\n### 5. CONFIGURA√á√ÉO DO TESTE (ap√≥s disparar an√°lise)\nAgora me diga, quantas perguntas voc√™ quer no teste: 3, 5 ou 10 perguntas?\n(ACEITE APENAS: 3, 5 ou 10)\n\n### 6. DISTRIBUI√á√ÉO (seja flex√≠vel mas mantenha a soma correta e use a tool de calculator para te auxiliar na soma para validar o total)\nex 1:\n3 perguntas: \n\n‚Ä¢ 3 perguntas de multipla-escolha?\n‚Ä¢ 2 perguntas de multipla-escolha e 1 pergunta aberta?\n\n----- ex 2:\n5 perguntas: \n\n‚Ä¢ 5 perguntas de multipla-escolha?\n‚Ä¢ 4 perguntas de multipla-escolha e 1 pergunta aberta?\n\n10 perguntas: \n‚Ä¢ 10 perguntas de multipla-escolha\n‚Ä¢ 8 perguntas de multipla-escolha e 2 perguntas abertas\n\n### 7. T√çTULO DO TESTE\n\"Por √∫ltimo, me diga qual ser√° o t√≠tulo do seu teste. Como voc√™ quer cham√°-lo?\" se o usuario n√£o souber, use o titulo do video que veio na tool de analisar_video_youtube\n\n### 8. GERA√á√ÉO\n\"Ok, vou gerar um teste sobre *[TEMA]* com [X] perguntas sendo [DISTRIBUI√á√ÉO], baseado no v√≠deo que voc√™ me enviou.\n\nPosso gerar o teste?\"\"\n\nap√≥s a confirma√ß√£o CHAME tool Gerar Question√°rio IMEDIATAMENTE\n\n### 9. RESULTADO\nForne√ßa os links usando o test_id retornado:\n- Criador do teste: https://manytest.bubbleapps.io/version-test/?id=[test_id]&edit=true\n- Respondente: https://manytest.bubbleapps.io/version-test/aluno?id=[test_id]\n\n## REGRAS R√çGIDAS:\n‚ùå NUNCA: Pedir dados pessoais, pular etapas, aceitar somas incorretas, explicar pedagogia, m√∫ltiplas perguntas\n‚úÖ SEMPRE: Seguir script, uma pergunta por vez, aguardar resposta, mostrar progresso\n‚úÖ SEMPRE: Disparar an√°lise do v√≠deo IMEDIATAMENTE ap√≥s receber URL v√°lida\n‚úÖ SEMPRE: Continuar coletando informa√ß√µes enquanto an√°lise roda em background\n\n## TOOLS:\n\n### \"Analisar V√≠deo YouTube\"\nChamar: IMEDIATAMENTE ap√≥s validar YouTube (etapa 4)\nPar√¢metros:\n- video_url: [URL completa]\n- video_id: [ID extra√≠do da URL]\n\n### \"Gerar Question√°rio\"\nChamar: Durante confirma√ß√£o final (etapa 8)\nPar√¢metros:\n- video_url: [URL do v√≠deo]\n- video_id: [ID do v√≠deo]\n- quiz_parameters: {\n    \"title\": \"[T√çTULO informado pelo usu√°rio]\",\n    \"total_questions\": [n√∫mero total],\n    \"multiple_choice_count\": [m√∫ltipla escolha],\n    \"essay_count\": [dissertativas],\n    \"difficulty\": \"medium\"\n  }\n\n## FLEXIBILIDADE:\n‚úÖ ACEITE: Varia√ß√µes de distribui√ß√£o que somem o total, diferentes formas de expressar escolhas\n‚úÖ ACEITE: mudan√ßas de escolhas\n‚úÖ FALE SOBRE O V√çDEO ap√≥s fazer a leitura (mencione brevemente o conte√∫do)\n‚ùå REJEITE: Links n√£o-YouTube, somas incorretas\n\n## OTIMIZA√á√ÉO DE TEMPO:\n- URL ‚Üí An√°lise IMEDIATA (background)\n- Configura√ß√£o do teste (quantidade + distribui√ß√£o)\n- T√≠tulo do teste\n- Gera√ß√£o com todos os dados prontos\n\nERROS:\n- Soma errada: \"A soma precisa ser [TOTAL]. Quantas m√∫ltipla escolha e quantas abertas?\"\n- Total inv√°lido: \"Escolha entre 3, 5 ou 10 perguntas.\"\n- Total inv√°lido: \"Por enquanto s√≥ consigo fazer at√© 10 quest√µes\"\n\nTom: Casual, natural, focado no resultado, eficiente."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -112,
        -208
      ],
      "id": "ca03ee4a-6f6f-4500-bf02-e4a7b42593b6",
      "name": "ManyTest Agent [Whatsapp]",
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chat-input",
              "name": "chatInput",
              "value": "={{ $json.chatInput }}",
              "type": "string"
            },
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{ $json.sessionId || $json.user_info.mobile_e164 ||'default-session' }}",
              "type": "string"
            },
            {
              "id": "user-context",
              "name": "userContext",
              "value": "={{ $json.user_info || {} }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -336,
        -208
      ],
      "id": "e8740a89-3a88-4390-a68d-44621bd82ea4",
      "name": "Dados de entrada"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "user",
              "value": "={{ $('Start').item.json.body_chatInput }}"
            },
            {
              "key": "AI",
              "value": "={{ $json.output }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1,
      "position": [
        240,
        -208
      ],
      "id": "962fb6a1-8c72-433a-add0-5621664de514",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "chatInput"
            },
            {
              "name": "user_info",
              "type": "object"
            }
          ]
        }
      },
      "id": "262e8684-028d-48dc-bb89-cb30450db459",
      "typeVersion": 1.1,
      "name": "Start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -576,
        -208
      ]
    },
    {
      "parameters": {
        "description": "# Ferramenta: Analisar V√≠deo do YouTube\n\nEsta ferramenta analisa um v√≠deo do YouTube para extrair transcri√ß√£o, resumo e t√≥picos principais. Chame essa tool IMEDIATAMENTE ap√≥s receber um link de video do youtube\n\n## Quando usar:\n- SEMPRE QUE receber um link v√°lido do YouTube\n\n## Retorna:\n- Transcri√ß√£o completa do v√≠deo\n- Resumo estruturado\n- T√≥picos principais com timestamps\n- Metadados do v√≠deo (t√≠tulo, dura√ß√£o, etc.)",
        "workflowId": {
          "__rl": true,
          "value": "nJdEKFn4IUoFP6IW",
          "mode": "list",
          "cachedResultUrl": "/workflow/nJdEKFn4IUoFP6IW",
          "cachedResultName": "Tool - An√°lise de videos Youtube"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "user_info": "={{ $json.userContext }}",
            "video_id": "={{ $fromAI('video_id', 'id do video extraido do link do youtube, exemplo https://www.youtube.com/watch?v=VIDEO_ID ou https://youtu.be/VIDEO_ID?si=V6emKxSJ8Oqyg51s se atente ao parse no ?', 'string') }}",
            "video_url": "={{ $fromAI('video_id', 'URL completa do v√≠deo do YouTube fornecida pelo usu√°rio. Exemplo: https://www.youtube.com/watch?v=VIDEO_ID ou https://youtu.be/VIDEO_ID?si=V6emKxSJ8Oqyg51', 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "video_id",
              "displayName": "video_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "video_url",
              "displayName": "video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "user_info",
              "displayName": "user_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        160,
        64
      ],
      "id": "cf4138c3-bbcc-4550-8ec2-40b8abb7b2e5",
      "name": "analisar_video_youtube"
    },
    {
      "parameters": {
        "description": "# Ferramenta: Gerar Question√°rio Educacional\n\nEsta ferramenta cria question√°rios estruturados baseados em v√≠deos do YouTube. Use quando o usu√°rio fornecer todas as informa√ß√µes necess√°rias e confirmar a cria√ß√£o.\n\n## Quando usar:\n- Ap√≥s coletar link do YouTube v√°lido\n- Depois de ter ar√¢metros do question√°rio definidos (t√≠tulo, quantidade, tipos)\n- Informa√ß√µes do usu√°rio coletadas\n- Confirma√ß√£o final recebida\n\n## Importante:\n- Valide se a soma de m√∫ltipla escolha + dissertativas = total\n- Use informa√ß√µes coletadas na conversa para preencher os campos",
        "workflowId": {
          "__rl": true,
          "value": "xfoD8YboKOGl6JDF",
          "mode": "list",
          "cachedResultUrl": "/workflow/xfoD8YboKOGl6JDF",
          "cachedResultName": "Tool - Gera√ß√£o de testes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "user_info": "={{ $json.userContext }}",
            "video_url": "={{ $fromAI('video_url', 'URL completa do v√≠deo do YouTube fornecida pelo usu√°rio. Exemplo: https://www.youtube.com/watch?v=VIDEO_ID', 'string') }}",
            "video_id": "={{ $fromAI('video_id', 'id do video extraido do link do youtube, exemplo https://www.youtube.com/watch?v=VIDEO_ID ou https://youtu.be/VIDEO_ID?si=V6emKxSJ8Oqyg51s se atente ao parse no ?', 'string') }}",
            "quiz_parameters": "={{ $fromAI('quiz_parameters', 'Objeto JSON com: {title: string, total_questions: number, multiple_choice_count: number, essay_count: number, difficulty: easy|medium|hard}', 'json') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "video_id",
              "displayName": "video_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "video_url",
              "displayName": "video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "quiz_parameters",
              "displayName": "quiz_parameters",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "user_info",
              "displayName": "user_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        400,
        64
      ],
      "id": "8eeda92f-de53-4504-ac01-c6a47f66ba2f",
      "name": "gerar_questionario"
    }
  ],
  "connections": {
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "ManyTest Agent [Whatsapp]",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "ManyTest Agent [Whatsapp]",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "ManyTest Agent [Whatsapp]",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "ManyTest Agent [Whatsapp]": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados de entrada": {
      "main": [
        [
          {
            "node": "ManyTest Agent [Whatsapp]",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start": {
      "main": [
        [
          {
            "node": "Dados de entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "analisar_video_youtube": {
      "ai_tool": [
        [
          {
            "node": "ManyTest Agent [Whatsapp]",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "gerar_questionario": {
      "ai_tool": [
        [
          {
            "node": "ManyTest Agent [Whatsapp]",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "17dc9ff6-0e85-4ac4-b4ec-1e46d9fae5af",
  "meta": {
    "instanceId": "00000000000000000000000000000000000000000000000000000000000000000"
  },
  "id": "szWvSBpULYlKmiWk",
  "tags": []
}