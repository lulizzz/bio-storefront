{
  "name": "1. Fluxo de mensagens",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "manytest",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -528,
        208
      ],
      "id": "7803de70-04aa-4396-b7af-c4390b1db87d",
      "name": "Webhook",
      "webhookId": "94fd6018-2fd1-4cc4-9e90-c1168405ea2b"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('variaveis').item.json.message.type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e5f2cf42-5398-4aad-8794-23490464a04b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "42356243-bff7-4541-89df-324a3d077031",
                    "leftValue": "={{ $('variaveis').item.json.message.type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        80,
        208
      ],
      "id": "2bb3cc4e-8610-4f1d-a660-6303b356c7dd",
      "name": "Switch - tipo de mensagem"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sincron.uazapi.com/message/download",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('variaveis').item.json.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.message.id }}"
            },
            {
              "name": "transcribe",
              "value": "={{ false }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        352,
        32
      ],
      "id": "c9927738-f41f-4ac4-af2d-667766e260b7",
      "name": "uazapi - post message download"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1488,
        32
      ],
      "id": "29fe3d01-e3d0-463f-bc8e-e95811c27269",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "Er8fjgP28B3h16av",
          "name": "OpenAi - Manytest"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.fileURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        560,
        32
      ],
      "id": "5a8f4f08-748d-4927-a5c5-96937e36c8d8",
      "name": "GET - url da media"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "623377e6-0e3b-4747-a464-79e60418eafa",
              "name": "text",
              "value": "={{ $json.text || $json.messages.map(item => item.parseJson().text).reverse().join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1744,
        208
      ],
      "id": "5be7b83d-3a76-4a1d-800e-4202c34eac33",
      "name": "normalização do texto"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5d9b4e6c-037d-4208-b218-ef459a4acf10",
              "name": "message.text",
              "value": "={{ $('variaveis').item.json.message.text }}",
              "type": "string"
            },
            {
              "id": "e67774ed-38bd-450c-94ac-7a5f9e0483fc",
              "name": "message.id",
              "value": "={{ $('variaveis').item.json.message.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        320,
        432
      ],
      "id": "a5e369f8-4f7e-454b-8df1-bb756b8f53ee",
      "name": "Entrada da mensagem na lista"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('variaveis').item.json.user.whatsapp }}_buffer",
        "messageData": "={{ $json.message.toJsonString() }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        560,
        432
      ],
      "id": "389ab441-ecaa-4a64-92bd-dd27ccf41a2a",
      "name": "Redis - inserir a mensagem",
      "credentials": {
        "redis": {
          "id": "RL94BpyzAwi3lFOJ",
          "name": "Redis - railway"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        784,
        432
      ],
      "id": "74210548-b17a-450c-9a80-e10d74dbb37e",
      "name": "Wait",
      "webhookId": "0e4a5032-51ea-4460-a342-06689833a83f"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6dbc3f56-de67-49f6-a581-e5dab99ad0d4",
              "leftValue": "={{ $json.messages[0].parseJson().id }}",
              "rightValue": "={{ $('variaveis').item.json.message.id }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1232,
        432
      ],
      "id": "182cfa2e-9a3b-4d27-8b04-7bc5c073b800",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "messages",
        "key": "={{ $('variaveis').item.json.user.whatsapp }}_buffer",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1008,
        432
      ],
      "id": "9b1482e5-9543-44de-93ac-3848796ea910",
      "name": "Redis - puxa a lista de mensagens",
      "credentials": {
        "redis": {
          "id": "RL94BpyzAwi3lFOJ",
          "name": "Redis - railway"
        }
      }
    },
    {
      "parameters": {
        "content": "## Entrada dos dados",
        "height": 280,
        "width": 380,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -560,
        112
      ],
      "id": "6bde459e-44a2-465d-b9dd-d0e18a1728ee",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Gerenciamento da mensagem",
        "height": 660,
        "width": 1840,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32,
        -64
      ],
      "id": "a36ea2e8-b033-4029-8792-36a649eaefd6",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('variaveis').item.json.user.whatsapp }}_buffer"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1488,
        400
      ],
      "id": "4b2a13c1-6f3d-4a87-a7d4-fa0fac83dded",
      "name": "Redis - Limpar lista",
      "credentials": {
        "redis": {
          "id": "RL94BpyzAwi3lFOJ",
          "name": "Redis - railway"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n-main-instance-production-9695.up.railway.app/webhook/htz/agent/",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chatInput",
              "value": "={{ $json.text }}"
            },
            {
              "name": "user_info",
              "value": "={{ $('get_user_info').item.json }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1984,
        -48
      ],
      "id": "fa3ad6df-518e-4b9d-b833-9739b7b60532",
      "name": "CALL agent"
    },
    {
      "parameters": {
        "content": "## Call agent",
        "height": 300,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1920,
        112
      ],
      "id": "7b9b2c48-2757-4828-912b-64101033f9f5",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://manytest.uazapi.com/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('variaveis').item.json.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('variaveis').item.json.user.whatsapp }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            },
            {
              "name": "linkPreview",
              "value": "={{false}}"
            },
            {
              "name": "delay",
              "value": "={{2500}}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2928,
        208
      ],
      "id": "da9537eb-b3c6-42fb-84ba-2db147b55b08",
      "name": "uazapi - send message"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Atualiza o nome do WhatsApp se o usuário existir e retorna os dados\nUPDATE test_maker \nSET whatsapp_name = $2\nWHERE mobile_e164 = $1\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $json.user.whatsapp }}, {{ $json.user.name }}"
        }
      },
      "id": "647e58ed-9775-4cca-84b2-f258e175419a",
      "name": "get_user_info",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -128,
        208
      ],
      "credentials": {
        "postgres": {
          "id": "SRbBuiGN9bR0qhkI",
          "name": "Postgres - manytest"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb886f3e-e306-4621-beec-c5a93a5da2c7",
              "name": "user.name",
              "value": "={{ $json.body.message.senderName }}",
              "type": "string"
            },
            {
              "id": "921e4ccd-23e8-4227-bdc1-3dfb63e06ce7",
              "name": "user.whatsapp",
              "value": "={{ $json.body.message.sender.split(\"@\")[0] }}",
              "type": "string"
            },
            {
              "id": "c3ed5257-01e2-4a3f-b1d1-79d884f2f18d",
              "name": "message.text",
              "value": "={{ $json.body.message.text }}",
              "type": "string"
            },
            {
              "id": "7a44a42a-ce6b-4a9c-b24c-ebda4f880031",
              "name": "message.id",
              "value": "={{ $json.body.message.messageid }}",
              "type": "string"
            },
            {
              "id": "8e108770-c7fc-453c-96af-acae9b8ec0cb",
              "name": "message.fromMe",
              "value": "={{ $json.body.message.fromMe }}",
              "type": "boolean"
            },
            {
              "id": "35ea7fa4-6a95-4b98-8d39-42c100005e4a",
              "name": "chat.group.name",
              "value": "={{ $json.body.message.groupName }}",
              "type": "string"
            },
            {
              "id": "f3aff982-3fde-4a84-8d90-159099c11efa",
              "name": "instance.token",
              "value": "={{ $json.body.token }}",
              "type": "string"
            },
            {
              "id": "40fa557a-87fa-40af-ac37-98bcf112ead7",
              "name": "instance.number",
              "value": "={{ $json.body.owner }}",
              "type": "string"
            },
            {
              "id": "ad551d23-fc67-43e4-8096-45e07bb979ca",
              "name": "chat.id",
              "value": "={{ $json.body.message.chatid.split(\"@\")[0] }}",
              "type": "string"
            },
            {
              "id": "1abd1721-c960-48f6-b9f8-a937d3343bfb",
              "name": "chat.isgroup",
              "value": "={{ $json.body.message.isGroup }}",
              "type": "boolean"
            },
            {
              "id": "d358b68d-d8f2-4184-8273-f42f95098848",
              "name": "message.type",
              "value": "={{ $json.body.messageType = \"Conversation\" ? \"text\" : $json.body.message.messageType.split(\"M\")[0].split(\"Extended\")[1] }}",
              "type": "string"
            },
            {
              "id": "c7b92bbd-db76-4363-9056-54f75ee93233",
              "name": "message.Timestamp",
              "value": "={{ $json.body.message.messageTimestamp }}",
              "type": "number"
            },
            {
              "id": "a6d4e297-5bbc-4e55-9907-5c2ea5e5829d",
              "name": "event.type",
              "value": "={{ $json.body.EventType }}",
              "type": "string"
            },
            {
              "id": "6e47cef8-3175-4e22-923f-9b620a630984",
              "name": "event.status",
              "value": "={{ $json.body.instance.status }}",
              "type": "string"
            },
            {
              "id": "ff4bd34e-88c2-42e1-b2a7-0acae1fa192b",
              "name": "instance.name",
              "value": "={{ $json.body.instance.name }}",
              "type": "string"
            },
            {
              "id": "e986dd05-d1e2-42d1-ab48-a99776fbf540",
              "name": "event.date",
              "value": "={{ $json.body.instance.lastDisconnect }}",
              "type": "string"
            },
            {
              "id": "1195961f-3d3a-4ab5-a46b-825882e947d8",
              "name": "event.reason",
              "value": "={{ $json.body.instance.lastDisconnectReason }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -320,
        208
      ],
      "id": "78bf0d35-fe88-4e4b-aa8e-9826366cd2e9",
      "name": "variaveis"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c38817e2-0246-469f-b361-053520548d21",
              "name": "output",
              "value": "={{ $json.output.split(\"\\n\\n\") }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2208,
        208
      ],
      "id": "5006a943-3b4b-4dbd-bd30-c60da6b17c6a",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        2688,
        208
      ],
      "id": "636ae5e1-d910-4d96-aa00-994fd7ab7eb9",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3152,
        208
      ],
      "id": "3465ee4a-5411-431e-a6bb-8f813cc06a30",
      "name": "Wait1",
      "webhookId": "061c1e37-adb5-47e9-a2eb-c6ce4f494a63"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        2432,
        208
      ],
      "id": "387a0580-ef77-41c8-996a-c651ef28fa18",
      "name": "Split Out"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "szWvSBpULYlKmiWk",
          "mode": "list",
          "cachedResultUrl": "/workflow/szWvSBpULYlKmiWk",
          "cachedResultName": "2 - Manitest Agent (Conversação)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatInput": "={{ $json.text }}",
            "user_info": "={{ $('get_user_info').item.json }}"
          },
          "matchingColumns": [
            "body_chatInput",
            "body_message",
            "body_input",
            "body_query",
            "body_user_info_mobile_e164",
            "body_session_id",
            "body_user_id",
            "body_user_info"
          ],
          "schema": [
            {
              "id": "chatInput",
              "displayName": "chatInput",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "user_info",
              "displayName": "user_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1984,
        208
      ],
      "name": "Call 2 - Manitest Agent (Conversação)",
      "id": "04ccffd9-9d10-46a4-a25c-0d6663616b93"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "variaveis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - tipo de mensagem": {
      "main": [
        [
          {
            "node": "uazapi - post message download",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Entrada da mensagem na lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "uazapi - post message download": {
      "main": [
        [
          {
            "node": "GET - url da media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "normalização do texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET - url da media": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "normalização do texto": {
      "main": [
        [
          {
            "node": "Call 2 - Manitest Agent (Conversação)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Entrada da mensagem na lista": {
      "main": [
        [
          {
            "node": "Redis - inserir a mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis - inserir a mensagem": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis - puxa a lista de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Redis - Limpar lista",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Redis - puxa a lista de mensagens": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis - Limpar lista": {
      "main": [
        [
          {
            "node": "normalização do texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_user_info": {
      "main": [
        [
          {
            "node": "Switch - tipo de mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "variaveis": {
      "main": [
        [
          {
            "node": "get_user_info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CALL agent": {
      "main": [
        []
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "uazapi - send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "uazapi - send message": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 2 - Manitest Agent (Conversação)": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Sao_Paulo",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "50b9e813-e009-458c-83df-219c15bcb258",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "00000000000000000000000000000000000000000000000000000000000000000"
  },
  "id": "0Y4Gmq0NcHzZC5zX",
  "tags": []
}