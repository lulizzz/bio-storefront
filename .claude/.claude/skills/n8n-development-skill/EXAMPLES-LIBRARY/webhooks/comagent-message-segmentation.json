{
  "name": "2. Segmenta√ß√£o de mensagens",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "process-whatsapp-message",
        "responseMode": "lastNode",
        "responseData": "allEntries",
        "options": {}
      },
      "id": "4b48b684-771c-4a04-9e6a-f5309a7d405c",
      "name": "Webhook - Receber Dados",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -2400,
        1440
      ],
      "webhookId": "whatsapp-processor-webhook"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4019c27f-406e-4a62-b8ee-51a4657b4ce0"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TEXT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "66e69203-cea3-4d4c-9c3b-b296c486ea09"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "AUDIO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1fc4db75-711e-4f8b-8252-6e0ddb661919"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IMAGE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "fc134c31-553f-4b66-8e48-50dec81db03f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "VIDEO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e1be0176-b29a-4d66-ac71-b20ca36db667"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DOCUMENT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "sticker",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "87c65220-8c63-4882-b163-89798a7d5d7b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STICKER"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "location",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "082ee0e8-e7fd-4b8f-aac0-4dd8d8aa4c52"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "LOCATION"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "69c5f078-23a6-4da4-98a5-4c9ffe442272",
                    "leftValue": "={{ $json.variaveis.message.type }}",
                    "rightValue": "Reaction",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "REACTION"
            }
          ]
        },
        "options": {
          "ignoreCase": true
        }
      },
      "id": "6a19f380-aab0-4e2a-8f47-e20223beb453",
      "name": "Switch - Tipo de Mensagem",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -1984,
        1344
      ],
      "notesInFlow": true,
      "notes": "Classifica mensagem por tipo:\n- TEXT: Mensagem de texto\n- AUDIO: √Åudio/Voice\n- IMAGE: Imagem/Foto\n- VIDEO: V√≠deo\n- DOCUMENT: PDF/Docs\n- REACTION: Emoji como rea√ß√£o\n- STICKER: Figurinha\n- LOCATION: Localiza√ß√£o"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ===================================================\n-- PROCESSAMENTO COMPLETO DE MENSAGEM WHATSAPP v4\n-- ===================================================\nBEGIN;\n\n-- 1. INSERIR/ATUALIZAR MEMBRO\nWITH upsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES ($2, $3, $3, to_timestamp($4::bigint / 1000.0))\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\n-- 2. INSERIR/ATUALIZAR RELACIONAMENTO MEMBRO-GRUPO\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, $1::bigint, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active',\n    updated_at = CURRENT_TIMESTAMP\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\n-- 3. INSERIR MENSAGEM\ninsert_message AS (\n  INSERT INTO messages (\n    message_id, \n    group_id, \n    member_id, \n    message, \n    type, \n    media_url, \n    media_size, \n    response_to, \n    response_to_id, \n    timestamp\n  )\n  SELECT \n    $5,                                       -- message_id\n    $1::bigint,                              -- group_id\n    um.id,                                   -- member_id\n    CASE \n      WHEN $6 = 'null' THEN NULL \n      ELSE $6::text \n    END,                                     -- message text\n    -- Valida√ß√£o e normaliza√ß√£o do tipo\n    CASE \n      WHEN LOWER($7) IN ('text', 'audio', 'image', 'video', 'document', 'sticker', 'location', 'contact', 'poll', 'reaction') \n      THEN LOWER($7)::text\n      ELSE 'text'::text\n    END,\n    CASE \n      WHEN $8 = 'null' THEN NULL \n      ELSE $8::text \n    END,                                     -- media_url\n    CASE \n      WHEN $8 = 'null' OR $8 IS NULL THEN NULL \n      ELSE 0 \n    END,                                     -- media_size\n    CASE \n      WHEN $9 = 'null' THEN NULL \n      ELSE $9::text \n    END,                                     -- response_to\n    CASE \n      WHEN $10 = 'null' THEN NULL \n      ELSE $10::text \n    END,                                     -- response_to_id\n    to_timestamp($4::bigint / 1000.0)        -- timestamp\n  FROM upsert_member um\n  WHERE NOT EXISTS (\n    SELECT 1 FROM messages WHERE message_id = $5\n  )\n  RETURNING id, type, group_id, member_id\n),\n-- 4. ATUALIZAR/INSERIR ATIVIDADE DI√ÅRIA\nupsert_activity AS (\n  INSERT INTO members_activity (\n    member_id, \n    group_id, \n    activity_date, \n    message_count, \n    media_count, \n    reaction_count\n  )\n  SELECT \n    um.id,\n    $1::bigint,\n    (to_timestamp($4::bigint / 1000.0) AT TIME ZONE 'America/Sao_Paulo')::date,\n    CASE \n      WHEN LOWER($7) IN ('text', 'sticker', 'location', 'contact', 'poll') OR LOWER($7) NOT IN ('audio', 'image', 'video', 'document', 'reaction') \n      THEN 1 ELSE 0 \n    END,\n    CASE WHEN LOWER($7) IN ('audio', 'image', 'video', 'document') THEN 1 ELSE 0 END,\n    CASE WHEN LOWER($7) = 'reaction' THEN 1 ELSE 0 END\n  FROM upsert_member um\n  WHERE EXISTS (SELECT 1 FROM insert_message)\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    message_count = members_activity.message_count + EXCLUDED.message_count,\n    media_count = members_activity.media_count + EXCLUDED.media_count,\n    reaction_count = members_activity.reaction_count + EXCLUDED.reaction_count,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, group_id, activity_date, message_count, media_count, reaction_count\n)\n-- 5. RETORNAR RESULTADO CONSOLIDADO\nSELECT \n  CASE \n    WHEN im.id IS NOT NULL THEN 'success'\n    WHEN EXISTS (SELECT 1 FROM messages WHERE message_id = $5) THEN 'duplicate'\n    ELSE 'error'\n  END as status,\n  json_build_object(\n    'member', json_build_object(\n      'id', um.id,\n      'phone', um.phone,\n      'name', um.name\n    ),\n    'message', CASE \n      WHEN im.id IS NOT NULL THEN json_build_object(\n        'id', im.id,\n        'type', im.type,\n        'saved_at', CURRENT_TIMESTAMP\n      )\n      ELSE json_build_object('status', 'not_inserted')\n    END,\n    'activity', CASE\n      WHEN ua.activity_date IS NOT NULL THEN json_build_object(\n        'date', ua.activity_date,\n        'messages', ua.message_count,\n        'media', ua.media_count,\n        'reactions', ua.reaction_count\n      )\n      ELSE NULL\n    END,\n    'processing_info', json_build_object(\n      'timestamp', to_timestamp($4::bigint / 1000.0),\n      'group_id', $1,\n      'message_type', LOWER($7),\n      'has_media', $8 != 'null' AND $8 IS NOT NULL,\n      'is_response', $10 != 'null' AND $10 IS NOT NULL\n    )\n  ) as result\nFROM upsert_member um\nLEFT JOIN insert_message im ON TRUE\nLEFT JOIN upsert_activity ua ON TRUE;\n\nCOMMIT;",
        "options": {
          "queryReplacement": "={{ $json.grupo.id }},{{ $json.variaveis.user.whatsapp }},{{ $json.variaveis.user.name || 'Usu√°rio sem nome' }},{{ $json.variaveis.message.timestamp }},{{ $json.variaveis.message.id }},{{ $json.variaveis.message.text ? '\"' + $json.variaveis.message.text + '\"' : 'null' }},{{ $json.variaveis.message.type || 'text' }},{{ $json.variaveis.message.media?.url || 'null' }},{{ $json.variaveis.message.responded?.text || 'null' }},{{ $json.variaveis.message.responded?.id || 'null' }}"
        }
      },
      "id": "289780ff-455c-4a6e-be33-91a40010628e",
      "name": "Salvar Mensagem Texto",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1632,
        352
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa mensagem de texto:\n- Insere/atualiza membro\n- Relaciona membro ao grupo\n- Salva mensagem\n- Atualiza atividade di√°ria"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- PROCESSAMENTO DE √ÅUDIO/VOZ - VERS√ÉO CORRIGIDA COMPLETA\nBEGIN;\n\n-- Buscar o ID interno do grupo\nWITH group_lookup AS (\n  SELECT id as group_id_internal\n  FROM groups \n  WHERE chat_id = $1\n),\nupsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES ($2, $3, $3, to_timestamp($4::bigint / 1000))\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, gl.group_id_internal, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active'\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\ninsert_message AS (\n  INSERT INTO messages (\n    message_id, group_id, member_id, message, type, \n    media_url, response_to, response_to_id, timestamp\n  )\n  SELECT \n    $5,                                              -- message_id\n    gl.group_id_internal,                           -- group_id (lookup)\n    um.id,                                          -- member_id\n    COALESCE(NULLIF($6, ''), '[√Åudio]'),           -- message ($6 - text)\n    LOWER($7),                                      -- type ($7 - convertido para min√∫sculo)\n    NULLIF($8, ''),                                 -- media_url ($8)\n    NULLIF($9, ''),                                 -- response_to ($9)\n    NULLIF($10, ''),                                -- response_to_id ($10)\n    to_timestamp($4::bigint / 1000)                 -- timestamp\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (message_id) DO NOTHING\n  RETURNING id, type, message\n),\nupsert_activity AS (\n  INSERT INTO members_activity (member_id, group_id, activity_date, message_count, media_count)\n  SELECT um.id, gl.group_id_internal, CURRENT_DATE, 0, 1\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    media_count = members_activity.media_count + 1,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, media_count\n),\n-- CRIAR ENTRADA PARA AN√ÅLISE DE CONTE√öDO (TRANSCRI√á√ÉO)\ninsert_content_analysis AS (\n  INSERT INTO content_analysis (message_id, content_type, processing_status)\n  SELECT im.id, 'audio', 'pending'\n  FROM insert_message im\n  WHERE $11::boolean = true  -- auto_transcription_enabled ($11)\n  RETURNING id, processing_status\n)\nSELECT \n  'audio_processed' as status,\n  json_build_object(\n    'member_id', um.id,\n    'member_name', um.name,\n    'group_id_internal', gl.group_id_internal,\n    'message_id', im.id,\n    'message_content', im.message,\n    'message_type', im.type,\n    'media_count', ua.media_count,\n    'transcription_queued', CASE WHEN $11::boolean THEN true ELSE false END\n  ) as result\nFROM upsert_member um\nCROSS JOIN group_lookup gl\nCROSS JOIN insert_message im\nCROSS JOIN upsert_activity ua;\n\nCOMMIT;",
        "options": {
          "queryReplacement": "={{ $('Dados').item.json.variaveis.chat.chatId }},{{ $('Dados').item.json.variaveis.user.whatsapp }},{{ $('Dados').item.json.variaveis.user.name || 'Usu√°rio sem nome' }},{{ $('Dados').item.json.variaveis.message.timestamp }},{{ $('Dados').item.json.variaveis.message.id }},{{ $json.text.replace(/,/g, '&#44;') || '' }},{{ $('Dados').item.json.variaveis.message.type }},{{ $('Uazapi - get audio url').item.json.fileURL || '' }},{{ $('Dados').item.json.variaveis.message.responded.text ? $('Dados').item.json.variaveis.message.responded.text.toJsonString() : null }},{{ $('Dados').item.json.variaveis.message.responded.id || null}},{{ $('Dados').item.json.grupo.auto_transcription_enabled }}"
        }
      },
      "id": "5dd38a6f-17e1-473a-8d7c-0283e670ad7a",
      "name": "Salvar Mensagem √Åudio",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1040,
        896
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa √°udio:\n- Salva como m√≠dia\n- Queue para transcri√ß√£o se habilitado\n- Atualiza contador de m√≠dia"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- PROCESSAMENTO DE REA√á√ÉO\nBEGIN;\n\nWITH upsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES ($2, $3, $3, to_timestamp($4::bigint / 1000.0))\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\n\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, $1::bigint, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active',\n    updated_at = CURRENT_TIMESTAMP\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\n\ninsert_reaction AS (\n  INSERT INTO messages (\n    message_id, group_id, member_id, message, type, \n    response_to, response_to_id, timestamp\n  )\n  SELECT \n    $5, $1::bigint, um.id, $6, 'reaction',\n    NULLIF($9, ''), NULLIF($10, ''), to_timestamp($4::bigint / 1000.0)\n  FROM upsert_member um\n  ON CONFLICT (message_id) DO NOTHING\n  RETURNING id, message, response_to_id\n),\n\nupsert_activity AS (\n  INSERT INTO members_activity (member_id, group_id, activity_date, reaction_count)\n  SELECT um.id, $1::bigint, CURRENT_DATE, 1\n  FROM upsert_member um\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    reaction_count = members_activity.reaction_count + 1,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, reaction_count\n)\n\nSELECT \n  'reaction_processed' as status,\n  json_build_object(\n    'member_id', um.id,\n    'reaction_id', ir.id,\n    'reaction_emoji', ir.message,\n    'reacted_to_message', ir.response_to_id,\n    'total_reactions_today', ua.reaction_count\n  ) as result\nFROM upsert_member um\nCROSS JOIN insert_reaction ir\nCROSS JOIN upsert_activity ua;\n\nCOMMIT;",
        "options": {
          "queryReplacement": "={{ $json.grupo.id }},{{ $json.variaveis.user.whatsapp }},{{ $json.variaveis.user.name || 'Usu√°rio sem nome' }},{{ $json.variaveis.message.timestamp }},{{ $json.variaveis.message.id }},{{ $json.variaveis.message.text || '' }},{{ $json.variaveis.message.type.toLowerCase() }},{{ null }},{{ $json.variaveis.message.responded.text || null }},{{ $json.variaveis.message.responded.id || '' }}"
        }
      },
      "id": "be768a96-69e4-4e48-b5d8-bb2ea59785bb",
      "name": "Salvar Rea√ß√£o",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1696,
        2512
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa rea√ß√£o:\n- Salva como mensagem tipo 'reaction'\n- Vincula √† mensagem original\n- Atualiza contador de rea√ß√µes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "final-status",
              "name": "processamento.status",
              "value": "={{ $json.status }}",
              "type": "string"
            },
            {
              "id": "final-timestamp",
              "name": "processamento.timestamp",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            },
            {
              "id": "final-result",
              "name": "processamento.result",
              "value": "={{ $json.result }}",
              "type": "object"
            },
            {
              "id": "final-type",
              "name": "processamento.message_type",
              "value": "={{ $json.result.processing_info?.message_type || $json.status.split('_')[0] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "38ac127f-4f8b-4c59-a674-dc9fea0b5b93",
      "name": "Resultado Final",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -1456,
        352
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://m7growth.uazapi.com/message/download",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Dados').first().json.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.variaveis.message.id }}"
            },
            {
              "name": "generate_mp3",
              "value": "={{true}}"
            },
            {
              "name": "return_link",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1616,
        896
      ],
      "id": "73a60b24-5ac2-473e-8e72-2cd477a9a993",
      "name": "Uazapi - get audio url"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -1232,
        896
      ],
      "id": "65254b20-3cce-4dec-8513-6e12b785843e",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "n54CK3O57Rvt7BgD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2176,
        1440
      ],
      "id": "eab98403-737b-4d81-8417-692b09322e1d",
      "name": "Dados"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "parsed-response",
              "name": "analise_completa",
              "value": "={{ JSON.parse($json.output[0].content[0].text)  }}",
              "type": "object"
            },
            {
              "id": "transcript-clean",
              "name": "transcript",
              "value": "={{ JSON.parse($json.output[0].content[0].text).transcript }}",
              "type": "string"
            },
            {
              "id": "insights-actions",
              "name": "insights_e_actions",
              "value": "={{ JSON.parse($json.output[0].content[0].text).insights_e_actions }}",
              "type": "array"
            },
            {
              "id": "summary",
              "name": "resumo_executivo",
              "value": "={{ JSON.parse($json.output[0].content[0].text).resumo_executivo }}",
              "type": "string"
            },
            {
              "id": "next-steps",
              "name": "proximos_passos",
              "value": "={{ JSON.parse($json.output[0].content[0].text).proximos_passos }}",
              "type": "array"
            },
            {
              "id": "b1b896bd-e256-4cb0-bc96-890812282e9c",
              "name": "text",
              "value": "={{ $json.output[0].content[0].text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3adf237b-6a72-4aea-932e-c213e24867e4",
      "name": "Processar Resposta da IA",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -128,
        976
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://m7growth.uazapi.com/message/download",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Webhook - Receber Dados').first().json.body.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.variaveis.message.id }}"
            },
            {
              "name": "return_link",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1408,
        1440
      ],
      "id": "97186f42-6549-4d08-b7ce-18ddc0512999",
      "name": "Uazapi - get aimage url"
    },
    {
      "parameters": {
        "url": "={{ $json.fileURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1232,
        1440
      ],
      "id": "faf9fbca-a5f5-4de9-9705-945ab51a17ac",
      "name": "download - image"
    },
    {
      "parameters": {
        "url": "={{ $json.fileURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1440,
        896
      ],
      "id": "4360f15a-11c8-451b-9c1e-97ac640240ee",
      "name": "download - audio"
    },
    {
      "parameters": {
        "documentType": "image_url",
        "options": {}
      },
      "type": "n8n-nodes-base.mistralAi",
      "typeVersion": 1,
      "position": [
        -1040,
        1440
      ],
      "id": "2a8d1c03-14e8-46e8-948d-624a26031d3e",
      "name": "Extract text",
      "credentials": {
        "mistralCloudApi": {
          "id": "4gTJ9zdmbFiv3lnM",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Resumo da transcri√ß√£o do √°udio\n",
        "height": 304,
        "width": 560,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -464,
        848
      ],
      "id": "343249b5-a1cd-49f7-9805-2a2b1c4cbefd",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt-system",
              "name": "prompt_system",
              "value": "=# Especialista em An√°lise de Documentos e Imagens\n\n## Sua Fun√ß√£o\nVoc√™ √© um especialista em an√°lise de conte√∫do extra√≠do de imagens, capaz de interpretar documentos, posts, gr√°ficos, e qualquer tipo de conte√∫do visual que foi convertido em texto via OCR.\n\n## Instru√ß√µes de An√°lise\n\n### 1. INTERPRETA√á√ÉO DO CONTE√öDO\n- Analise o texto extra√≠do da imagem\n- Identifique o tipo de documento/conte√∫do\n- Compreenda o contexto e prop√≥sito\n- Organize as informa√ß√µes de forma l√≥gica\n\n### 2. TIPOS DE CONTE√öDO COMUNS\n**Documentos Fiscais:**\n- Notas fiscais, cupons, recibos\n- Extraia: estabelecimento, itens, valores, data\n\n**Posts/Redes Sociais:**\n- Tweets, posts LinkedIn, Instagram\n- Extraia: mensagem principal, m√©tricas, insights\n\n**Gr√°ficos/Relat√≥rios:**\n- Dashboards, funis, m√©tricas\n- Extraia: dados principais, tend√™ncias, conclus√µes\n\n**Curr√≠culos/CVs:**\n- Experi√™ncias, forma√ß√£o, habilidades\n- Extraia: qualifica√ß√µes principais, experi√™ncia relevante\n\n**Pesquisas/Formul√°rios:**\n- Resultados, feedback, dados coletados\n- Extraia: insights principais, padr√µes, conclus√µes\n\n### 3. FORMATO DE RESPOSTA\n\nForne√ßa uma an√°lise clara e objetiva com:\n\n**üìã RESUMO:**\n[Resumo de 2-3 frases do conte√∫do principal]\n\n**üîç PONTOS IMPORTANTES:**\n‚Ä¢ [Ponto relevante 1]\n‚Ä¢ [Ponto relevante 2] \n‚Ä¢ [Ponto relevante 3]\n\n**üí° INSIGHTS/OBSERVA√á√ïES:**\n[Observa√ß√µes adicionais, padr√µes identificados ou recomenda√ß√µes]\n\n### 4. DIRETRIZES DE QUALIDADE\n\n- **Seja claro e objetivo**: Evite jarg√µes desnecess√°rios\n- **Priorize relev√¢ncia**: Foque no que √© mais importante\n- **Mantenha contexto**: Preserve informa√ß√µes essenciais\n- **Use linguagem adequada**: Para comunica√ß√£o em grupo\n- **Seja conciso**: Informa√ß√£o √∫til sem verbosidade\n\n### 5. EXEMPLOS DE AN√ÅLISE\n\n**Para Nota Fiscal:**\nüìã RESUMO: Compra no WMB Supermercados totalizando R$ 250,95 com 8 itens diversos incluindo produtos de limpeza, alimenta√ß√£o e higiene.\n\nüîç PONTOS IMPORTANTES:\n‚Ä¢ Total gasto: R$ 250,95\n‚Ä¢ 8 itens comprados\n‚Ä¢ Pagamento via cart√£o de d√©bito\n‚Ä¢ Tributos: R$ 69,11\n\n**Para Post de Rede Social:**\nüìã RESUMO: Patrick Collison (Stripe) compartilha crescimento de 145% na plataforma de cobran√ßa por uso, indicando transi√ß√£o do modelo de assentos para consumo.\n\nüîç PONTOS IMPORTANTES:\n‚Ä¢ Crescimento de 145% YTD na cobran√ßa por uso\n‚Ä¢ Transi√ß√£o j√° acontecendo na ind√∫stria\n‚Ä¢ Questionamento sobre efeitos secund√°rios\n\n### 6. INSTRU√á√ïES ESPECIAIS\n\n- Adapte o formato conforme o tipo de conte√∫do\n- Se for conte√∫do t√©cnico, simplifique para leigos\n- Se for documento oficial, mantenha precis√£o\n- Se houver dados num√©ricos, destaque os mais relevantes\n- Se for conte√∫do promocional, identifique a mensagem central\n\n**IMPORTANTE:** Seja sempre √∫til e direto. Sua an√°lise ser√° compartilhada em um grupo, ent√£o deve agregar valor real √† discuss√£o.",
              "type": "string"
            },
            {
              "id": "prompt-user",
              "name": "prompt_user",
              "value": "=Analise o seguinte conte√∫do extra√≠do de uma imagem e forne√ßa um resumo √∫til com os pontos mais importantes:\n\n## Conte√∫do Extra√≠do da Imagem:\n{{ $json.markdown }}\n\n---\n\nPor favor, analise este conte√∫do e forne√ßa um resumo claro e pontos importantes conforme as instru√ß√µes.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "65a54f9b-6dec-4377-a3eb-1810880ac8ff",
      "name": "Preparar Prompts para An√°lise2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -640,
        1440
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "gpt-4.1"
            },
            {
              "name": "instructions",
              "value": "={{ $json.prompt_system }}"
            },
            {
              "name": "input",
              "value": "={{ $json.prompt_user }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ca61a2a3-01d3-470e-9a34-387cc5750b1b",
      "name": "OpenAI - An√°lise de Imagem1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -432,
        1440
      ],
      "retryOnFail": true,
      "credentials": {
        "openAiApi": {
          "id": "n54CK3O57Rvt7BgD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "analise-resultado",
              "name": "analise_resultado",
              "value": "={{ $json.output[0].content[0].text }}",
              "type": "string"
            },
            {
              "id": "mensagem-grupo",
              "name": "mensagem_para_grupo",
              "value": "=*An√°lise da Imagem:*\n{{ $json.output[0].content[0].text }}",
              "type": "string"
            },
            {
              "id": "tipo-conteudo",
              "name": "tipo_conteudo",
              "value": "={{ $json.output[0].content[0].text.includes('üìã') ? 'documento_analisado' : 'conteudo_geral' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "dd66e1a4-593f-482a-bbae-b4c348f76f5a",
      "name": "Processar Resposta da IA2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -240,
        1440
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Dados').first().json.variaveis.instance.host }}/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Dados').first().json.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Dados').first().json.variaveis.chat.chatId }}@g.us"
            },
            {
              "name": "text",
              "value": "={{ $json.mensagem_para_grupo }}"
            },
            {
              "name": "linkPreview",
              "value": "={{false}}"
            },
            {
              "name": "readchat",
              "value": "={{ true }}"
            },
            {
              "name": "replyid",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        64,
        1440
      ],
      "id": "327aa823-aba1-4046-87c3-be3ba3cf0a06",
      "name": "uazapi - send auto transcribe1"
    },
    {
      "parameters": {
        "content": "## Resumo da leitura da imagem",
        "height": 256,
        "width": 592,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -688,
        1376
      ],
      "id": "a6f3c2cc-510e-4927-ba1d-777e88e40c35",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8337d5f0-91d1-4789-93b7-d24b45164f6d",
              "leftValue": "={{ $('Dados').first().json.grupo.pdf_summary_enabled }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1616,
        1440
      ],
      "id": "f635f075-36a3-4dc2-89e4-3ddcade0dbb5",
      "name": "If - PDF analisys = true",
      "executeOnce": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "509d65c0-38e2-4026-ab7b-8cf77c0e4c1c",
              "leftValue": "={{ $('Dados').first().json.grupo.auto_transcription_enabled }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -848,
        896
      ],
      "id": "1ea20f71-4724-487a-ae42-abad34c8d6d8",
      "name": "If - Auto transcribe = True"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "fromMe",
              "value": "={{ $json.variaveis.message.fromMe }}"
            },
            {
              "key": "event",
              "value": "={{ $json.variaveis.event.type }}"
            },
            {
              "key": "whatsapp",
              "value": "={{ $json.variaveis.user.whatsapp }}"
            },
            {
              "key": "chatId",
              "value": "={{ $json.variaveis.chat.chatId }}"
            },
            {
              "key": "type",
              "value": "={{ $json.variaveis.message.type.toLowerCase() }}"
            },
            {
              "key": "group",
              "value": "={{ $json.grupo.name }}"
            },
            {
              "key": "user",
              "value": "={{ $json.variaveis.user.name }}"
            },
            {
              "key": "text",
              "value": "={{ $json.variaveis.message.text }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -2032,
        1024
      ],
      "id": "180f815a-448f-4d23-bf10-12f6637efce4",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8695b663-63ed-4aad-9c4c-b102670e2a57",
              "leftValue": "={{(() => {\n  const text = $('Dados').first().json.variaveis.message.text || '';\n  const regex = /https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be)\\//i;\n  return regex.test(text);\n})()}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "785cf960-2662-4c55-9d6c-311f413d97dc",
              "leftValue": "={{ $('Dados').first().json.grupo.youtube_auto_transcript_enabled }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1264,
        352
      ],
      "id": "c1de0fff-33f1-46d6-bcbb-04206f03f7a2",
      "name": "If - have youtube link"
    },
    {
      "parameters": {
        "url": "https://yt-api.p.rapidapi.com/video/info",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{(() => {\n  const text = $('Dados').first().json.variaveis.message.text || '';\n  const regex = /(?:youtube\\.com\\/.*v=|youtu\\.be\\/)([a-zA-Z0-9_-]{11})/;\n  const match = text.match(regex);\n  return match ? match[1] : null;\n})()}}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-rapidapi-host",
              "value": "yt-api.p.rapidapi.com"
            },
            {
              "name": "x-rapidapi-key",
              "value": "7ec1e52098msh44f6062ec155202p1b7468jsn8a69257736f6"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1072,
        352
      ],
      "id": "0b98f2b3-7358-439d-830c-85ad03e607dc",
      "name": "Get - video info"
    },
    {
      "parameters": {
        "url": "https://youtube-transcript-extractor-api.p.rapidapi.com/transcript",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "videoId",
              "value": "={{ $('Get - video info').item.json.id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-rapidapi-host",
              "value": "youtube-transcript-extractor-api.p.rapidapi.com"
            },
            {
              "name": "x-rapidapi-key",
              "value": "7ec1e52098msh44f6062ec155202p1b7468jsn8a69257736f6"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -224,
        224
      ],
      "id": "d7b8031b-69cc-4e76-b735-068553194b44",
      "name": "Get - Video transcription"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt-system",
              "name": "prompt_system",
              "value": "=# Especialista em Resumo de V√≠deos para Grupos\n\n## Sua Fun√ß√£o\nVoc√™ √© um especialista em analisar transcri√ß√µes de v√≠deos e criar resumos envolventes e informativos para compartilhamento em grupos de WhatsApp.\n\n## Instru√ß√µes de An√°lise\n\n### 1. AN√ÅLISE DO CONTE√öDO\n- Analise a transcri√ß√£o completa do v√≠deo\n- Identifique o tipo de conte√∫do (tutorial, entrevista, palestra, review, etc.)\n- Compreenda o valor e prop√≥sito do v√≠deo\n- Identifique apresentadores, convidados e suas credenciais\n- Extraia experi√™ncias, casos pr√°ticos e li√ß√µes compartilhadas\n\n### 2. ESTRUTURA OBRIGAT√ìRIA\n\n**üé¨ [T√çTULO DO V√çDEO]**\nüë§ Canal: [Nome do Canal] | ‚è±Ô∏è [Dura√ß√£o]\n\n**üìã RESUMO:**\n[2-3 par√°grafos que expliquem:\n- O valor e prop√≥sito do v√≠deo\n- Quem s√£o os apresentadores/convidados e suas credenciais/experi√™ncias\n- As principais ideias, conceitos e experi√™ncias compartilhadas\n- Por que vale a pena assistir]\n\n**üî• DESTAQUES:**\n‚Ä¢ [3-4 pontos mais importantes do v√≠deo]\n‚Ä¢ [Ferramentas, frameworks ou conceitos mencionados]\n‚Ä¢ [Dados, estat√≠sticas ou cases interessantes]\n‚Ä¢ [Dicas pr√°ticas ou actionables]\n\n**‚è∞ MOMENTOS-CHAVE:**\n[3-5 timestamps com os t√≥picos mais relevantes]\nXX:XX - [T√≥pico importante]\nXX:XX - [Outro t√≥pico relevante]\nXX:XX - [Mais um ponto]\n\n**üí° INSIGHTS:**\n‚Ä¢ [4-5 insights de valor que podem ser aplicados]\n‚Ä¢ [Li√ß√µes aprendidas ou experi√™ncias compartilhadas]\n‚Ä¢ [Tend√™ncias ou previs√µes mencionadas]\n‚Ä¢ [Conex√µes com outros conceitos ou √°reas]\n‚Ä¢ [Takeaways pr√°ticos para implementa√ß√£o]\n\n### 3. DIRETRIZES ESPEC√çFICAS\n\n**Para o RESUMO:**\n- Seja persuasivo sobre o valor do conte√∫do\n- Destaque a expertise dos apresentadores\n- Mencione cases, experi√™ncias ou hist√≥rias interessantes\n- Explique claramente o que o espectador vai aprender\n- Use linguagem acess√≠vel mas profissional\n\n**Para os INSIGHTS:**\n- Foque em aplicabilidade pr√°tica\n- Extraia li√ß√µes que v√£o al√©m do √≥bvio\n- Conecte conceitos com situa√ß√µes reais\n- Identifique padr√µes ou tend√™ncias\n- Sugira a√ß√µes concretas quando poss√≠vel\n\n**Para MOMENTOS-CHAVE:**\n- Use os timestamps fornecidos na transcri√ß√£o\n- Escolha os t√≥picos mais relevantes\n- Seja espec√≠fico sobre o que √© discutido\n- Priorize conte√∫do pr√°tico ou surpreendente\n\n### 4. TIPOS DE CONTE√öDO COMUNS\n\n**Tutoriais/T√©cnicos:**\n- Destaque ferramentas, frameworks, metodologias\n- Foque em aplicabilidade e resultados pr√°ticos\n- Mencione n√≠vel de dificuldade se relevante\n\n**Entrevistas/Podcasts:**\n- Destaque background e expertise dos convidados\n- Foque em experi√™ncias e hist√≥rias √∫nicas\n- Extraia li√ß√µes de carreira e neg√≥cios\n\n**Reviews/An√°lises:**\n- Destaque crit√©rios de avalia√ß√£o\n- Foque em pr√≥s, contras e recomenda√ß√µes\n- Mencione contexto de uso\n\n**Palestras/Confer√™ncias:**\n- Destaque conceitos inovadores\n- Foque em vis√µes de futuro e tend√™ncias\n- Extraia insights estrat√©gicos\n\n### 5. QUALIDADE DO RESUMO\n\n- **Seja conciso mas completo**: M√°ximo 300-400 palavras\n- **Use linguagem envolvente**: Desperte curiosidade\n- **Mantenha objetividade**: Informa√ß√£o √∫til sem fluff\n- **Adapte o tom**: Profissional mas acess√≠vel para grupos\n- **Priorize valor**: Foque no que realmente importa\n\n**IMPORTANTE:** O resumo deve convencer algu√©m a assistir o v√≠deo mostrando claramente o valor e os benef√≠cios que ter√°.",
              "type": "string"
            },
            {
              "id": "prompt-user",
              "name": "prompt_user",
              "value": "=Analise a seguinte transcri√ß√£o de v√≠deo e crie um resumo estruturado para compartilhamento em grupo do WhatsApp:\n\n## Dados do V√≠deo:\n**T√≠tulo:** {{ $json.video.title }}\n**Canal:** {{ $json.video.channel.title }}\n**Dura√ß√£o:** {{ $json.video.length }}\n**Descri√ß√£o:** {{ $json.video.description }}\n\n## Transcri√ß√£o:\n{{ $json.video.transcript }}\n\n---\n\nCrie um resumo seguindo exatamente a estrutura definida, focando no valor do conte√∫do e nos insights pr√°ticos que podem ser extra√≠dos.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "b96d4a66-c009-4211-b938-0bd7a2b1b06a",
      "name": "Preparar Prompts para An√°lise de V√≠deo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        176,
        224
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "gpt-4.1"
            },
            {
              "name": "instructions",
              "value": "={{ $json.prompt_system }}"
            },
            {
              "name": "input",
              "value": "={{ $json.prompt_user }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f8125932-33c3-40e2-85f7-e326ad2352e5",
      "name": "OpenAI - An√°lise de V√≠deo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        384,
        224
      ],
      "retryOnFail": true,
      "credentials": {
        "openAiApi": {
          "id": "n54CK3O57Rvt7BgD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "resumo-video",
              "name": "resumo_video",
              "value": "={{ $json.output[0].content[0].text }}",
              "type": "string"
            },
            {
              "id": "mensagem-whatsapp",
              "name": "mensagem_whatsapp",
              "value": "={{ $json.output[0].content[0].text }}",
              "type": "string"
            },
            {
              "id": "titulo-video",
              "name": "titulo_video",
              "value": "={{ $('Code - corrige sa√≠da').item.json.video.title }}",
              "type": "string"
            },
            {
              "id": "canal-video",
              "name": "canal_video",
              "value": "={{ $('Code - corrige sa√≠da').item.json.video.channel.title }}",
              "type": "string"
            },
            {
              "id": "duracao-video",
              "name": "duracao_video",
              "value": "={{ $('Code - corrige sa√≠da').item.json.video.length }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "a8117e9f-f671-49d6-8bc3-f8041af91e3c",
      "name": "Processar Resumo do V√≠deo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        576,
        224
      ]
    },
    {
      "parameters": {
        "content": "## Resumo da transcri√ß√£o do video Youtube\n",
        "height": 256,
        "width": 592,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        128,
        144
      ],
      "id": "5fb941f6-444c-47b4-aa05-8e4a809b9c8c",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://m7growth.uazapi.com/message/download",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Dados').first().json.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.variaveis.message.id }}"
            },
            {
              "name": "return_link",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1456,
        1840
      ],
      "id": "b4e51ae5-05bc-453b-b368-b01dab13ece3",
      "name": "Uazapi - get aimage url1"
    },
    {
      "parameters": {
        "url": "={{ $json.fileURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1248,
        1888
      ],
      "id": "63e7c2ef-37b3-4909-a37f-e5b3bba156c6",
      "name": "download - image1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "parsed-analysis",
              "name": "analise_pdf_completa",
              "value": "={{ JSON.parse($json.output[0].content[0].text) }}",
              "type": "object"
            },
            {
              "id": "status-doc",
              "name": "status_documento",
              "value": "={{ JSON.parse($json.output[0].content[0].text).status }}",
              "type": "string"
            },
            {
              "id": "tipo-doc",
              "name": "tipo_documento",
              "value": "={{ JSON.parse($json.output[0].content[0].text).tipo_documento }}",
              "type": "string"
            },
            {
              "id": "whatsapp-response",
              "name": "resposta_whatsapp",
              "value": "={{ JSON.parse($json.output[0].content[0].text).resposta_whatsapp }}",
              "type": "object"
            },
            {
              "id": "detailed-analysis",
              "name": "analise_detalhada",
              "value": "={{ JSON.parse($json.output[0].content[0].text).analise_detalhada }}",
              "type": "object"
            },
            {
              "id": "embedding-data",
              "name": "dados_embedding",
              "value": "={{ JSON.parse($json.output[0].content[0].text).dados_embedding }}",
              "type": "object"
            },
            {
              "id": "filters",
              "name": "filtros_aplicaveis",
              "value": "={{ JSON.parse($json.output[0].content[0].text).filtros_aplicaveis }}",
              "type": "object"
            },
            {
              "id": "confidence",
              "name": "confianca_classificacao",
              "value": "={{ JSON.parse($json.output[0].content[0].text).confianca_classificacao }}",
              "type": "number"
            },
            {
              "id": "9cb657c3-5374-4eb6-aed6-b9deb44022fd",
              "name": "documento_id",
              "value": "={{$now.toMillis()}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "304c1057-1ed9-41f9-b672-051647711fe7",
      "name": "Processar Resposta - An√°lise PDF",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        336,
        1936
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "gpt-4.1"
            },
            {
              "name": "instructions",
              "value": "={{ $json.prompt_system }}"
            },
            {
              "name": "input",
              "value": "={{ $json.prompt_user }}"
            },
            {
              "name": "text",
              "value": "={{ JSON.parse($json.schema) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "01a4d227-b791-4048-afd3-698216d2164a",
      "name": "OpenAI - An√°lise PDF1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        1936
      ],
      "retryOnFail": true,
      "credentials": {
        "openAiApi": {
          "id": "n54CK3O57Rvt7BgD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH member_upsert AS (\n  INSERT INTO members (phone, name, status)\n  VALUES (\n    ($1::jsonb->>'user_phone')::varchar,\n    ($1::jsonb->>'user_name')::varchar,\n    'active'\n  )\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    updated_at = (now() AT TIME ZONE 'America/Sao_Paulo'::text)\n  RETURNING id as member_id\n),\nmessage_insert AS (\n  INSERT INTO messages (\n    message_id,\n    group_id,\n    member_id,\n    type,\n    timestamp,\n    media_url,\n    message\n  )\n  VALUES (\n    ($1::jsonb->>'message_id')::varchar,\n    ($1::jsonb->>'group_id')::bigint,\n    (SELECT member_id FROM member_upsert),\n    CASE \n      WHEN ($1::jsonb->>'message_type')::varchar = 'Document' THEN 'document'\n      WHEN ($1::jsonb->>'message_type')::varchar = 'Audio' THEN 'audio'\n      WHEN ($1::jsonb->>'message_type')::varchar = 'Image' THEN 'image'\n      WHEN ($1::jsonb->>'message_type')::varchar = 'Video' THEN 'video'\n      ELSE 'text'\n    END,\n    to_timestamp(($1::jsonb->>'timestamp')::bigint / 1000),\n    ($1::jsonb->>'media_url')::text,\n    CASE \n      WHEN ($1::jsonb->>'content_type')::text = 'pdf' THEN \n        'Documento PDF: ' || COALESCE(($1::jsonb->'normalized_metadata'->>'title')::text, 'Documento sem t√≠tulo')\n      ELSE ($1::jsonb->>'message_text')::text\n    END\n  )\n  ON CONFLICT (message_id) DO NOTHING\n  RETURNING id as internal_message_id, message_id\n),\nmessage_lookup AS (\n  SELECT \n    COALESCE(mi.internal_message_id, existing.id) as internal_message_id,\n    COALESCE(mi.message_id, existing.message_id) as message_id\n  FROM (SELECT 1) dummy\n  LEFT JOIN message_insert mi ON true\n  LEFT JOIN messages existing ON existing.message_id = ($1::jsonb->>'message_id')::varchar\n    AND mi.internal_message_id IS NULL\n),\ncontent_analysis_insert AS (\n  INSERT INTO content_analysis (\n    message_id,\n    content_type,\n    agent_type,\n    document_type,\n    acceptance_status,\n    confidence_score,\n    full_content,\n    normalized_metadata,\n    content_hash,\n    rag_reference_id,\n    summary,\n    extracted_data,\n    processing_status\n  )\n  SELECT \n    ml.internal_message_id,\n    ($1::jsonb->>'content_type')::text,\n    ($1::jsonb->>'agent_type')::text,\n    ($1::jsonb->>'document_type')::text,\n    ($1::jsonb->>'acceptance_status')::text,\n    ($1::jsonb->>'confidence_score')::float,\n    ($1::jsonb->>'full_content')::text,\n    ($1::jsonb->'normalized_metadata')::jsonb,\n    ($1::jsonb->>'content_hash')::text,\n    COALESCE(($1::jsonb->>'rag_reference_id')::text, '0'),\n    ($1::jsonb->>'summary')::text,\n    ($1::jsonb->'extracted_data')::jsonb,\n    ($1::jsonb->>'processing_status')::text\n  FROM message_lookup ml\n  RETURNING id, rag_reference_id, message_id\n)\nSELECT \n  json_build_object(\n    'status', 'success',\n    'message', 'Content analysis saved successfully',\n    'content_analysis_id', cai.id,\n    'rag_reference_id', cai.rag_reference_id,\n    'internal_message_id', cai.message_id,\n    'whatsapp_message_id', ml.message_id\n  ) as result\nFROM content_analysis_insert cai, message_lookup ml;",
        "options": {
          "queryReplacement": "={{ JSON.stringify({\n  // Dados do usu√°rio/membro\n  user_phone: $json.user_info.whatsapp,\n  user_name: $json.user_info.name,\n  \n  // Dados da mensagem\n  message_id: $json.message_info.id,\n  group_id: $json.group_info.id,\n  message_type: $json.content_type,\n  timestamp: $json.message_info.timestamp,\n  media_url: $json.media_url,\n  message_text: $json.full_content || null,\n  \n  // Dados da an√°lise de conte√∫do (do n√≥ de normaliza√ß√£o)\n  content_type: $json.content_type,\n  agent_type: $json.agent_type,\n  document_type: $json.document_type,\n  acceptance_status: $json.acceptance_status,\n  confidence_score: $json.confidence_score,\n  full_content: $json.full_content,\n  normalized_metadata: $json.normalized_metadata,\n  content_hash: $json.whatsapp_message_id,\n  rag_reference_id: \"0\",\n  summary: $json.summary,\n  extracted_data: $json.extracted_data,\n  processing_status: $json.processing_status,\n}) }}"
        }
      },
      "id": "847845d6-d2fd-4773-97ba-eae4e99a9c9b",
      "name": "INSERT content_analysis (PostgreSQL)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1312,
        1136
      ],
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      }
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "whatsapp_message_id"
            },
            {
              "name": "agent_type"
            },
            {
              "name": "content_type"
            },
            {
              "name": "document_type"
            },
            {
              "name": "acceptance_status"
            },
            {
              "name": "confidence_score",
              "type": "number"
            },
            {
              "name": "full_content"
            },
            {
              "name": "normalized_metadata",
              "type": "object"
            },
            {
              "name": "summary"
            },
            {
              "name": "extracted_data",
              "type": "object"
            },
            {
              "name": "processing_status"
            },
            {
              "name": "group_info",
              "type": "object"
            },
            {
              "name": "user_info",
              "type": "object"
            },
            {
              "name": "message_info",
              "type": "object"
            },
            {
              "name": "media_url"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        1088,
        1136
      ],
      "id": "e5340500-eef8-4f70-afb4-7b29ff22f7b1",
      "name": "Salvar mensagem e preparar para RAG"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.mistralAi",
      "typeVersion": 1,
      "position": [
        -512,
        1792
      ],
      "id": "8cfc3ae0-6638-4f1d-a82a-b65c34d7f298",
      "name": "DOC Reader",
      "credentials": {
        "mistralCloudApi": {
          "id": "4gTJ9zdmbFiv3lnM",
          "name": "Mistral Cloud account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt-system",
              "name": "prompt_system",
              "value": "=# Especialista em An√°lise de Documentos PDF\n\n## Sua Fun√ß√£o\nVoc√™ √© um especialista em an√°lise de documentos PDF para grupos do WhatsApp, capaz de classificar tipos de documentos, extrair insights valiosos e determinar se o conte√∫do deve ser aceito ou rejeitado para an√°lise detalhada.\n\n## Tipos de Documentos - Classifica√ß√£o\n\n### DOCUMENTOS ACEITOS (An√°lise Detalhada):\n- PESQUISA_ACADEMICA: Estudos acad√™micos, disserta√ß√µes, teses\n- ARTIGO_CIENTIFICO: Papers, artigos cient√≠ficos, estudos peer-reviewed\n- NOTICIA: Reportagens jornal√≠sticas, mat√©rias informativas\n- RELATORIO_TECNICO: Relat√≥rios de tecnologia, engenharia, sistemas\n- MANUAL_TECNICO: Manuais de opera√ß√£o, guias t√©cnicos, coisas relacionadas a marketing e an√∫ncios de plataforma\n- WHITEPAPER: Documentos t√©cnicos empresariais, propostas t√©cnicas\n- ESTUDO_DE_CASO: Case studies, an√°lises de casos pr√°ticos\n- ANALISE_MERCADO: Estudos de mercado, an√°lises econ√¥micas\n- DOCUMENTO_EDUCACIONAL: Material did√°tico, apostilas, cursos\n- TUTORIAL: Guias pr√°ticos, how-to, instru√ß√µes\n- GUIA_TECNICO: Documenta√ß√£o t√©cnica, especifica√ß√µes,coisas relacionadas a marketing e an√∫ncios\n- DOCUMENTACAO_API: Documenta√ß√£o de APIs, SDKs\n- APRESENTACAO_TECNICA: Slides t√©cnicos, apresenta√ß√µes corporativas\n- ESPECIFICACAO_PRODUTO: Specs de produtos, requirements\n- DICAS_CONFIGURACAO: Documentos com dicas de configura√ß√£o de an√∫ncios, campanhas, site...\n\n### DOCUMENTOS REJEITADOS (Apenas Classifica√ß√£o):\n- CURRICULO: CVs, curr√≠culos pessoais\n- PORTFOLIO_PESSOAL: Portfolios individuais, work samples pessoais\n- PROPAGANDA_POLITICA: Material de campanhas politicas, panfletos pol√≠ticos\n- DOCUMENTO_PESSOAL: Documentos de identidade, certid√µes\n- CONTRATO: Contratos comerciais, acordos legais\n- DOCUMENTO_FINANCEIRO: Extratos, comprovantes, faturas\n- SPAM: Conte√∫do promocional indesejado\n- DOCUMENTO_JURIDICO: Processos, peti√ß√µes, pareceres legais\n\n## Instru√ß√µes de An√°lise\n\n### Para DOCUMENTOS ACEITOS:\n1. **Extraia informa√ß√µes completas**: t√≠tulo, autor, resumo executivo\n2. **Identifique insights principais**: pontos-chave, descobertas importantes\n3. **Extraia conclus√µes**: resultados, recomenda√ß√µes, next steps\n4. **Colete dados relevantes**: n√∫meros, estat√≠sticas, fatos importantes\n5. **Prepare dados para embedding**: palavras-chave, conceitos, trechos importantes\n6. **Crie resposta formatada para WhatsApp**: usando emojis e estrutura clara\n\n### Para DOCUMENTOS REJEITADOS:\n1. **Classifique o tipo correto**\n2. **Defina confian√ßa da classifica√ß√£o**\n3. **Crie resposta educativa para WhatsApp** explicando por que n√£o foi analisado\n4. **N√ÉO extraia dados detalhados** (deixe campos como null)\n\n## Emojis por Categoria\n- PESQUISA_ACADEMICA: üî¨\n- ARTIGO_CIENTIFICO: üìä\n- NOTICIA: üì∞\n- RELATORIO_TECNICO: üìã\n- MANUAL_TECNICO: üîß\n- WHITEPAPER: üìÑ\n- ESTUDO_DE_CASO: üíº\n- ANALISE_MERCADO: üìà\n- DOCUMENTO_EDUCACIONAL: üìö\n- TUTORIAL: üéØ\n- GUIA_TECNICO: ‚öôÔ∏è\n- DOCUMENTACAO_API: üíª\n- APRESENTACAO_TECNICA: üñºÔ∏è\n- ESPECIFICACAO_PRODUTO: üìù\n- CURRICULO: ‚ùå\n- PROPAGANDA_POLITICA: ‚ùå\n- DOCUMENTO_PESSOAL: ‚ùå\n- CONTRATO: ‚ùå\n- SPAM: ‚ùå\n\n## N√≠veis de Complexidade\n- **BASICA**: Conte√∫do acess√≠vel ao p√∫blico geral\n- **INTERMEDIARIA**: Requer conhecimento espec√≠fico da √°rea\n- **AVANCADA**: Conte√∫do altamente t√©cnico ou especializado\n\n## Tamanhos de Documento\n- **PEQUENO**: At√© 3 p√°ginas\n- **MEDIO**: 4-50 p√°ginas\n- **GRANDE**: Mais de 50 p√°ginas\n\n## Diretrizes de Qualidade\n\n1. **Seja preciso na classifica√ß√£o**: Use a confian√ßa para indicar certeza\n2. **Resposta WhatsApp deve ser clara**: M√°ximo 1500 caracteres, bem formatada\n3. **Para aceitos**: Extraia maximum value do conte√∫do\n4. **Para rejeitados**: Seja educativo, n√£o apenas restritivo\n5. **Palavras-chave**: 5-15 palavras mais relevantes\n6. **Conceitos principais**: 3-7 conceitos-chave\n7. **Trechos importantes**: M√°ximo 3 trechos, m√°ximo 200 caracteres cada\n\n## IMPORTANTE\n- Responda APENAS com JSON v√°lido\n- Para documentos rejeitados: analise_detalhada = null, dados_embedding = null\n- Para documentos aceitos: preencha todos os campos obrigat√≥rios\n- Use linguagem brasileira (pt-br)\n- Mantenha contexto profissional mas acess√≠vel",
              "type": "string"
            },
            {
              "id": "prompt-user",
              "name": "prompt_user",
              "value": "=Analise o seguinte conte√∫do extra√≠do de um PDF enviado em um grupo do WhatsApp:\n\n## Conte√∫do do PDF:\n{{(() => {\n  const pages = $json.pages;\n  return pages.map(p => `# p√°gina ${p.index + 1}: ${p.markdown}`).join('\\n\\n');\n})()}}{{ $json.text }}\n\n## Instru√ß√µes:\n1. Classifique o tipo de documento usando os ENUMs definidos\n2. Determine se deve ser ACEITO (an√°lise detalhada) ou REJEITADO (apenas classifica√ß√£o)\n3. Se ACEITO: extraia todos os insights, dados e informa√ß√µes para embedding\n4. Se REJEITADO: explique educativamente por que n√£o foi analisado\n5. Crie uma resposta bem formatada para WhatsApp\n6. Defina tags autom√°ticas apropriadas\n\n## Informa√ß√µes Adicionais:\n- Total de p√°ginas: {{ $json.numpages || $('DOC Reader').first().json.pageCount }}\n- Documento enviado em grupo WhatsApp\n- Contexto: An√°lise para compartilhamento e indexa√ß√£o\n\nResponda no formato JSON especificado.",
              "type": "string"
            },
            {
              "id": "schema-response",
              "name": "schema",
              "value": "={\n  \"format\": {\n    \"type\": \"json_schema\",\n  \"name\": \"analise_pdf\",\n  \"schema\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"status\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"aceito\",\n          \"rejeitado\"\n        ],\n        \"description\": \"Status do documento para an√°lise\"\n      },\n      \"tipo_documento\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"PESQUISA_ACADEMICA\",\n          \"ARTIGO_CIENTIFICO\",\n          \"NOTICIA\",\n          \"RELATORIO_TECNICO\",\n          \"MANUAL_TECNICO\",\n          \"WHITEPAPER\",\n          \"ESTUDO_DE_CASO\",\n          \"ANALISE_MERCADO\",\n          \"DOCUMENTO_EDUCACIONAL\",\n          \"TUTORIAL\",\n          \"GUIA_TECNICO\",\n          \"DOCUMENTACAO_API\",\n          \"APRESENTACAO_TECNICA\",\n          \"ESPECIFICACAO_PRODUTO\",\n          \"CURRICULO\",\n          \"PORTFOLIO_PESSOAL\",\n          \"PROPAGANDA_POLITICA\",\n          \"DOCUMENTO_PESSOAL\",\n          \"CONTRATO\",\n          \"DOCUMENTO_FINANCEIRO\",\n          \"SPAM\",\n          \"DOCUMENTO_PROMOCIONAL\",\n          \"DOCUMENTO_JURIDICO\",\n          \"CERTIFICADO\"\n        ],\n        \"description\": \"Tipo classificado do documento\"\n      },\n      \"confianca_classificacao\": {\n        \"type\": \"number\",\n        \"minimum\": 0,\n        \"maximum\": 1,\n        \"description\": \"N√≠vel de confian√ßa na classifica√ß√£o (0-1)\"\n      },\n      \"resposta_whatsapp\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"texto_formatado\": {\n            \"type\": \"string\",\n            \"description\": \"Texto formatado para envio no WhatsApp com emojis\"\n          },\n          \"emoji_categoria\": {\n            \"type\": \"string\",\n            \"description\": \"Emoji representativo da categoria\"\n          },\n          \"resumo_curto\": {\n            \"type\": \"string\",\n            \"description\": \"Resumo em uma linha do documento\"\n          }\n        },\n        \"required\": [\n          \"texto_formatado\",\n          \"emoji_categoria\",\n          \"resumo_curto\"\n        ],\n        \"additionalProperties\": false\n      },\n      \"analise_detalhada\": {\n        \"anyOf\": [\n          {\n            \"$ref\": \"#/$defs/analise_detalhada\"\n          },\n          {\n            \"type\": \"null\"\n          }\n        ],\n        \"description\": \"An√°lise detalhada do documento, pode ser nulo\"\n      },\n      \"dados_embedding\": {\n        \"anyOf\": [\n          {\n            \"$ref\": \"#/$defs/dados_embedding\"\n          },\n          {\n            \"type\": \"null\"\n          }\n        ],\n        \"description\": \"Dados para embedding, pode ser nulo\"\n      },\n      \"filtros_aplicaveis\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"tags_automaticas\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            },\n            \"description\": \"Tags autom√°ticas para filtragem\"\n          },\n          \"complexidade\": {\n            \"type\": \"string\",\n            \"enum\": [\n              \"basica\",\n              \"intermediaria\",\n              \"avancada\"\n            ],\n            \"description\": \"N√≠vel de complexidade do documento\"\n          },\n          \"tamanho\": {\n            \"type\": \"string\",\n            \"enum\": [\n              \"pequeno\",\n              \"medio\",\n              \"grande\"\n            ],\n            \"description\": \"Tamanho do documento\"\n          },\n          \"idioma\": {\n            \"type\": \"string\",\n            \"description\": \"Idioma do documento\"\n          }\n        },\n        \"required\": [\n          \"tags_automaticas\",\n          \"complexidade\",\n          \"tamanho\",\n          \"idioma\"\n        ],\n        \"additionalProperties\": false\n      }\n    },\n    \"required\": [\n      \"status\",\n      \"tipo_documento\",\n      \"confianca_classificacao\",\n      \"resposta_whatsapp\",\n      \"analise_detalhada\",\n      \"dados_embedding\",\n      \"filtros_aplicaveis\"\n    ],\n    \"additionalProperties\": false,\n    \"$defs\": {\n      \"analise_detalhada\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"titulo\": {\n            \"type\": \"string\",\n            \"description\": \"T√≠tulo do documento\"\n          },\n          \"autor\": {\n            \"type\": \"string\",\n            \"description\": \"Autor ou autores do documento\"\n          },\n          \"resumo_executivo\": {\n            \"type\": \"string\",\n            \"description\": \"Resumo executivo do conte√∫do\"\n          },\n          \"insights_principais\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            },\n            \"description\": \"Lista de insights principais extra√≠dos\"\n          },\n          \"conclusoes\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            },\n            \"description\": \"Conclus√µes e recomenda√ß√µes\"\n          },\n          \"dados_relevantes\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            },\n            \"description\": \"Dados, n√∫meros e fatos relevantes\"\n          }\n        },\n        \"required\": [\n          \"titulo\",\n          \"autor\",\n          \"resumo_executivo\",\n          \"insights_principais\",\n          \"conclusoes\",\n          \"dados_relevantes\"\n        ],\n        \"additionalProperties\": false\n      },\n      \"dados_embedding\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"palavras_chave\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            },\n            \"description\": \"Palavras-chave principais do documento\"\n          },\n          \"conceitos_principais\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            },\n            \"description\": \"Conceitos e temas principais\"\n          },\n          \"metadados\": {\n            \"type\": \"object\",\n            \"properties\": {\n              \"num_paginas\": {\n                \"type\": \"integer\",\n                \"description\": \"N√∫mero de p√°ginas do documento\"\n              },\n              \"idioma\": {\n                \"type\": \"string\",\n                \"description\": \"Idioma do documento\"\n              },\n              \"data_documento\": {\n                \"anyOf\": [\n                  {\n                    \"type\": \"string\"\n                  },\n                  {\n                    \"type\": \"null\"\n                  }\n                ],\n                \"description\": \"Data do documento se dispon√≠vel\"\n              }\n            },\n            \"required\": [\n              \"num_paginas\",\n              \"idioma\",\n              \"data_documento\"\n            ],\n            \"additionalProperties\": false\n          },\n          \"trechos_importantes\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"object\",\n              \"properties\": {\n                \"texto\": {\n                  \"type\": \"string\",\n                  \"description\": \"Trecho importante do documento\"\n                },\n                \"pagina\": {\n                  \"anyOf\": [\n                    {\n                      \"type\": \"integer\"\n                    },\n                    {\n                      \"type\": \"null\"\n                    }\n                  ],\n                  \"description\": \"P√°gina onde o trecho se encontra\"\n                },\n                \"relevancia\": {\n                  \"type\": \"string\",\n                  \"enum\": [\n                    \"alta\",\n                    \"media\",\n                    \"baixa\"\n                  ],\n                  \"description\": \"N√≠vel de relev√¢ncia do trecho\"\n                }\n              },\n              \"required\": [\n                \"texto\",\n                \"pagina\",\n                \"relevancia\"\n              ],\n              \"additionalProperties\": false\n            },\n            \"description\": \"Trechos importantes para embedding\"\n          }\n        },\n        \"required\": [\n          \"palavras_chave\",\n          \"conceitos_principais\",\n          \"metadados\",\n          \"trechos_importantes\"\n        ],\n        \"additionalProperties\": false\n      }\n    }\n  },\n  \"strict\": true\n}\n}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "14a29820-1bce-49b4-98e0-e972d4ea8516",
      "name": "Preparar Prompts - An√°lise DOC",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -64,
        1936
      ],
      "executeOnce": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "7KHUAXuTh186zhIc",
          "mode": "list",
          "cachedResultName": "2. Segmenta√ß√£o de mensagens"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "full_content": "={{(() => {\n  const analise = $('Processar Resposta - An√°lise PDF').first().json.analise_detalhada;\n  const dados = $('Processar Resposta - An√°lise PDF').first().json.dados_embedding;\n  \n  if (!analise) return 'Conte√∫do n√£o dispon√≠vel';\n  \n  let content = `T√çTULO: ${analise.titulo || 'Sem t√≠tulo'}\\n`;\n  content += `AUTOR: ${analise.autor || 'N√£o informado'}\\n`;\n  content += `RESUMO: ${analise.resumo_executivo || ''}\\n\\n`;\n  \n  if (analise.insights_principais && analise.insights_principais.length > 0) {\n    content += `INSIGHTS PRINCIPAIS:\\n`;\n    content += analise.insights_principais.map(i => `‚Ä¢ ${i}`).join('\\n') + '\\n\\n';\n  }\n  \n  if (analise.conclusoes && analise.conclusoes.length > 0) {\n    content += `CONCLUS√ïES:\\n`;\n    content += analise.conclusoes.map(c => `‚Ä¢ ${c}`).join('\\n') + '\\n\\n';\n  }\n  \n  if (analise.dados_relevantes && analise.dados_relevantes.length > 0) {\n    content += `DADOS RELEVANTES:\\n`;\n    content += analise.dados_relevantes.map(d => `‚Ä¢ ${d}`).join('\\n') + '\\n\\n';\n  }\n  \n  if (dados && dados.trechos_importantes && dados.trechos_importantes.length > 0) {\n    content += `TRECHOS IMPORTANTES:\\n`;\n    content += dados.trechos_importantes.map(t => `P√°gina ${t.pagina || 'N/A'}: ${t.texto}`).join('\\n');\n  }\n  \n  return content;\n})() }}",
            "normalized_metadata": "={{(() => {\n  const analise = $('Processar Resposta - An√°lise PDF').first().json.analise_detalhada;\n  const dados = $('Processar Resposta - An√°lise PDF').first().json.dados_embedding;\n  const filtros = $('Processar Resposta - An√°lise PDF').first().json.filtros_aplicaveis;\n  \n  return {\n    title: analise?.titulo || 'Documento sem t√≠tulo',\n    author: analise?.autor || 'N√£o informado',\n    summary: analise?.resumo_executivo || '',\n    keywords: dados?.palavras_chave || [],\n    concepts: dados?.conceitos_principais || [],\n    tags: filtros?.tags_automaticas || [],\n    language: filtros?.idioma || 'pt-br',\n    complexity: filtros?.complexidade || 'basica',\n    size: filtros?.tamanho || 'pequeno',\n    page_count: dados?.metadados?.num_paginas || null,\n    duration_seconds: null,\n    source_url: null,\n    channel_name: null,\n    video_title: null\n  };\n})() }}",
            "whatsapp_message_id": "={{ $('Dados').first().json.variaveis.message.id }}",
            "confidence_score": "={{ $('Processar Resposta - An√°lise PDF').first().json.confianca_classificacao }}",
            "agent_type": "pdf_analyzer",
            "content_type": "pdf",
            "document_type": "={{ $('Processar Resposta - An√°lise PDF').first().json.tipo_documento }}",
            "acceptance_status": "={{ $('Processar Resposta - An√°lise PDF').first().json.status_documento }}",
            "summary": "={{ $('Processar Resposta - An√°lise PDF').first().json.resposta_whatsapp.texto_formatado }}",
            "extracted_data": "={{ $('Processar Resposta - An√°lise PDF').first().json.analise_pdf_completa }}",
            "processing_status": "completed",
            "group_info": "={{ $('Dados').first().json.grupo }}",
            "user_info": "={{ $('Dados').first().json.variaveis.user }}",
            "message_info": "={{ $('Dados').first().json.variaveis.message }}",
            "media_url": "={{ $('Uazapi - get aimage url1').first().json.fileURL }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "whatsapp_message_id",
              "displayName": "whatsapp_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "agent_type",
              "displayName": "agent_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "content_type",
              "displayName": "content_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "acceptance_status",
              "displayName": "acceptance_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "confidence_score",
              "displayName": "confidence_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "full_content",
              "displayName": "full_content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "normalized_metadata",
              "displayName": "normalized_metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "extracted_data",
              "displayName": "extracted_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "processing_status",
              "displayName": "processing_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "group_info",
              "displayName": "group_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "user_info",
              "displayName": "user_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "message_info",
              "displayName": "message_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "media_url",
              "displayName": "media_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1440,
        1920
      ],
      "id": "cf0ccafe-47c1-4778-a28e-cc7259cf7b5e",
      "name": "Execute RAG insert Workflow"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "full-content-video",
              "name": "full_content",
              "value": "={{(() => {\n  const video = $('Code - corrige sa√≠da').item.json.video;\n  const resumo = $json.resumo_video;\n  \n  let content = `T√çTULO: ${video.title || 'V√≠deo sem t√≠tulo'}\\n`;\n  content += `CANAL: ${video.channel?.title || 'Canal n√£o informado'}\\n`;\n  content += `DURA√á√ÉO: ${video.length || 'N√£o informada'}\\n`;\n  content += `URL: ${video.url || 'URL n√£o dispon√≠vel'}\\n\\n`;\n  \n  if (video.description) {\n    content += `DESCRI√á√ÉO ORIGINAL:\\n${video.description}\\n\\n`;\n  }\n  \n  content += `RESUMO ESTRUTURADO:\\n${resumo}\\n\\n`;\n  \n  if (video.transcript) {\n    content += `TRANSCRI√á√ÉO COMPLETA:\\n${video.transcript}`;\n  }\n  \n  return content;\n})()}}",
              "type": "string"
            },
            {
              "id": "normalized-metadata-video",
              "name": "normalized_metadata",
              "value": "={{(() => {\n  const video = $('Code - corrige sa√≠da').item.json.video;\n  \n  return {\n    title: video.title || 'V√≠deo sem t√≠tulo',\n    author: video.channel?.title || 'Canal n√£o informado',\n    summary: $('Processar Resumo do V√≠deo').first().json.resumo_video,\n    keywords: $('Processar Resumo do V√≠deo').first().json.resumo_video.toLowerCase().split(' ').filter(w => w.length > 4).slice(0, 15),\n    concepts: ['v√≠deo educacional', 'conte√∫do digital', 'aprendizado'],\n    tags: ['video', 'youtube', 'educacional'],\n    language: 'pt-br',\n    complexity: 'intermediaria',\n    size: 'medio',\n    page_count: null,\n    duration_seconds: video.duration_seconds || null,\n    source_url: video.url,\n    channel_name: video.channel?.title,\n    video_title: video.title\n  };\n})()}}",
              "type": "object"
            },
            {
              "id": "extracted-data-video",
              "name": "extracted_data",
              "value": "={{(() => {\n  const video = $('Code - corrige sa√≠da').item.json.video;\n  const resumo = $('Processar Resumo do V√≠deo').first().json.resumo_video;\n  \n  return {\n    video_data: {\n      title: video.title,\n      channel: video.channel?.title,\n      duration: video.length,\n      url: video.url,\n      description: video.description\n    },\n    analysis: {\n      structured_summary: resumo,\n      content_type: 'educational_video',\n      processing_date: new Date().toISOString()\n    },\n    transcript: {\n      available: !!video.transcript,\n      length: video.transcript ? video.transcript.length : 0\n    },\n    metadata: {\n      analyzed_by: 'youtube_analyzer',\n      format: 'video',\n      language: 'pt-br'\n    }\n  };\n})()}}",
              "type": "object"
            },
            {
              "id": "video-fields",
              "name": "whatsapp_message_id",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}",
              "type": "string"
            },
            {
              "id": "agent-type",
              "name": "agent_type",
              "value": "youtube_analyzer",
              "type": "string"
            },
            {
              "id": "content-type",
              "name": "content_type",
              "value": "video",
              "type": "string"
            },
            {
              "id": "document-type",
              "name": "document_type",
              "value": "VIDEO_EDUCACIONAL",
              "type": "string"
            },
            {
              "id": "acceptance-status",
              "name": "acceptance_status",
              "value": "aceito",
              "type": "string"
            },
            {
              "id": "confidence-score",
              "name": "confidence_score",
              "value": 0.9,
              "type": "number"
            },
            {
              "id": "summary-whatsapp",
              "name": "summary",
              "value": "={{ $('Processar Resumo do V√≠deo').first().json.resumo_video }}",
              "type": "string"
            },
            {
              "id": "processing-status",
              "name": "processing_status",
              "value": "completed",
              "type": "string"
            },
            {
              "id": "group-id",
              "name": "id_group",
              "value": "={{ $('Dados').first().json.grupo.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "5a8fa9b8-9004-420e-a056-1dcae3f489b4",
      "name": "Normalizar Dados do V√≠deo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1136,
        224
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "9juHqjbEZKtTroOJ",
          "mode": "list",
          "cachedResultName": "2- Segmenta√ß√£o de mensagens"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "whatsapp_message_id": "={{ $json.whatsapp_message_id }}",
            "agent_type": "={{ $json.agent_type }}",
            "content_type": "={{ $json.content_type }}",
            "document_type": "={{ $json.document_type }}",
            "acceptance_status": "={{ $json.acceptance_status }}",
            "confidence_score": "={{ $json.confidence_score }}",
            "full_content": "={{ $json.full_content }}",
            "normalized_metadata": "={{ $json.normalized_metadata }}",
            "summary": "={{ $json.summary }}",
            "extracted_data": "={{ $json.extracted_data }}",
            "processing_status": "={{ $json.processing_status }}",
            "group_info": "={{ $('Dados').first().json.grupo }}",
            "user_info": "={{ $('Dados').first().json.variaveis.user }}",
            "message_info": "={{ $('Dados').first().json.variaveis.message }}",
            "media_url": "=https://www.youtube.com/watch?v={{ $('Get - video info').item.json.id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "whatsapp_message_id",
              "displayName": "whatsapp_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "agent_type",
              "displayName": "agent_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "content_type",
              "displayName": "content_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "acceptance_status",
              "displayName": "acceptance_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "confidence_score",
              "displayName": "confidence_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "full_content",
              "displayName": "full_content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "normalized_metadata",
              "displayName": "normalized_metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "extracted_data",
              "displayName": "extracted_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "processing_status",
              "displayName": "processing_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "group_info",
              "displayName": "group_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "user_info",
              "displayName": "user_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "message_info",
              "displayName": "message_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "media_url",
              "displayName": "media_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1328,
        224
      ],
      "id": "b118655c-48d1-45d6-9a2e-36cb1c2e8e47",
      "name": "Execute RAG Insert Workflow - V√≠deo",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "full-content-image",
              "name": "full_content",
              "value": "={{(() => {\n  const conteudoOriginal = $('Extraction').item.json.markdown || 'Conte√∫do n√£o extra√≠do';\n  const analiseIA = $('Processar Resposta da IA2').first().json.analise_resultado;\n  \n  let content = `TIPO: An√°lise de Imagem/Documento\\n`;\n  content += `DATA PROCESSAMENTO: ${new Date().toISOString()}\\n\\n`;\n  \n  content += `CONTE√öDO EXTRA√çDO DA IMAGEM (OCR):\\n${conteudoOriginal}\\n\\n`;\n  \n  content += `AN√ÅLISE ESTRUTURADA DA IA:\\n${analiseIA}\\n\\n`;\n  \n  content += `TIPO DE CONTE√öDO IDENTIFICADO: ${$json.tipo_conteudo}\\n`;\n  \n  return content;\n})()}}",
              "type": "string"
            },
            {
              "id": "normalized-metadata-image",
              "name": "normalized_metadata",
              "value": "={{(() => {\n  const conteudoOriginal = $('Extraction').item.json.markdown || '';\n  const analise = $('Processar Resposta da IA2').first().json.analise_resultado;\n  \n  // Extrair palavras-chave do conte√∫do\n  const texto = (conteudoOriginal + ' ' + analise).toLowerCase();\n  const palavrasChave = texto.split(' ')\n    .filter(w => w.length > 4)\n    .filter((v, i, a) => a.indexOf(v) === i)\n    .slice(0, 15);\n  \n  // Determinar tipo de documento baseado no conte√∫do\n  let tipoDocumento = 'documento_geral';\n  if (texto.includes('nota fiscal') || texto.includes('cupom') || texto.includes('recibo')) {\n    tipoDocumento = 'documento_fiscal';\n  } else if (texto.includes('post') || texto.includes('twitter') || texto.includes('linkedin')) {\n    tipoDocumento = 'post_rede_social';\n  } else if (texto.includes('gr√°fico') || texto.includes('dashboard') || texto.includes('relat√≥rio')) {\n    tipoDocumento = 'grafico_relatorio';\n  }\n  \n  return {\n    title: 'Imagem/Documento ' + new Date().toLocaleDateString('pt-BR'),\n    author: 'Extra√ß√£o OCR + IA',\n    summary: analise.substring(0, 200) + '...',\n    keywords: palavrasChave,\n    concepts: ['imagem', 'documento', 'ocr', tipoDocumento],\n    tags: ['image', 'ocr', 'documento', $json.tipo_conteudo],\n    language: 'pt-br',\n    complexity: 'basica',\n    size: 'pequeno',\n    page_count: 1,\n    duration_seconds: null,\n    source_url: null,\n    channel_name: null,\n    video_title: null\n  };\n})()}}",
              "type": "object"
            },
            {
              "id": "extracted-data-image",
              "name": "extracted_data",
              "value": "={{(() => {\n  return {\n    image_analysis: {\n      original_ocr_content: $('Extraction').item.json.markdown,\n      ai_structured_analysis: $('Processar Resposta da IA2').first().json.analise_resultado,\n      content_type_detected: $('Processar Resposta da IA2').first().json.tipo_conteudo,\n      processing_date: new Date().toISOString()\n    },\n    metadata: {\n      analyzed_by: 'image_analyzer',\n      format: 'image',\n      language: 'pt-br',\n      ocr_available: !!$('Extraction').item.json.markdown,\n      content_length: ($('Extraction').item.json.markdown || '').length\n    },\n    whatsapp_context: {\n      message_id: $('Dados').item.json.variaveis.message.id,\n      group_id: $('Dados').first().json.grupo.id,\n      media_url: $('Dados').item.json.variaveis.message.media?.url\n    }\n  };\n})()}}",
              "type": "object"
            },
            {
              "id": "image-fields",
              "name": "whatsapp_message_id",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}",
              "type": "string"
            },
            {
              "id": "agent-type-image",
              "name": "agent_type",
              "value": "image_analyzer",
              "type": "string"
            },
            {
              "id": "content-type-image",
              "name": "content_type",
              "value": "image",
              "type": "string"
            },
            {
              "id": "document-type-image",
              "name": "document_type",
              "value": "IMAGEM_DOCUMENTO",
              "type": "string"
            },
            {
              "id": "acceptance-status-image",
              "name": "acceptance_status",
              "value": "aceito",
              "type": "string"
            },
            {
              "id": "confidence-score-image",
              "name": "confidence_score",
              "value": 0.8,
              "type": "number"
            },
            {
              "id": "summary-image",
              "name": "summary",
              "value": "={{ $('Processar Resposta da IA2').first().json.mensagem_para_grupo }}",
              "type": "string"
            },
            {
              "id": "processing-status-image",
              "name": "processing_status",
              "value": "completed",
              "type": "string"
            },
            {
              "id": "group-id-image",
              "name": "id_group",
              "value": "={{ $('Dados').first().json.grupo.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "48483aaa-9a76-4514-961b-7a0bf4641695",
      "name": "Normalizar Dados da Imagem",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        1440
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "9juHqjbEZKtTroOJ",
          "mode": "list",
          "cachedResultName": "2- Segmenta√ß√£o de mensagens"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "whatsapp_message_id": "={{ $json.whatsapp_message_id }}",
            "agent_type": "={{ $json.agent_type }}",
            "content_type": "={{ $json.content_type }}",
            "document_type": "={{ $json.document_type }}",
            "acceptance_status": "={{ $json.acceptance_status }}",
            "confidence_score": "={{ $json.confidence_score }}",
            "full_content": "={{ $json.full_content }}",
            "normalized_metadata": "={{ $json.normalized_metadata }}",
            "summary": "={{ $json.summary }}",
            "extracted_data": "={{ $json.extracted_data }}",
            "processing_status": "={{ $json.processing_status }}",
            "user_info": "={{ $('Dados').first().json.variaveis.user }}",
            "group_info": "={{ $('Dados').first().json.grupo }}",
            "message_info": "={{ $('Dados').first().json.variaveis.message }}",
            "media_url": "={{ $('Uazapi - get aimage url').first().json.fileURL }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "whatsapp_message_id",
              "displayName": "whatsapp_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "agent_type",
              "displayName": "agent_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "content_type",
              "displayName": "content_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "acceptance_status",
              "displayName": "acceptance_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "confidence_score",
              "displayName": "confidence_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "full_content",
              "displayName": "full_content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "normalized_metadata",
              "displayName": "normalized_metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "extracted_data",
              "displayName": "extracted_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "processing_status",
              "displayName": "processing_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "group_info",
              "displayName": "group_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "user_info",
              "displayName": "user_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "message_info",
              "displayName": "message_info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "media_url",
              "displayName": "media_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        608,
        1440
      ],
      "id": "4cb5a135-9b86-40e5-bd55-2f01afe69bea",
      "name": "Execute RAG Insert Workflow - Imagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d68271a7-c152-4671-a8ab-9e04f853c802",
              "name": "markdown",
              "value": "={{ $json.pages[0].markdown }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -848,
        1440
      ],
      "id": "785bf99e-ba39-45d2-8167-9ee2b28fd81a",
      "name": "Extraction",
      "executeOnce": true
    },
    {
      "parameters": {
        "content": "## Salvar mensagem",
        "height": 80,
        "width": 400
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1712,
        224
      ],
      "id": "35e256d9-5bc4-49e5-96fb-51625a669499",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Verifica se o canal √© liberado",
        "height": 80,
        "width": 528,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1264,
        224
      ],
      "id": "bf0ea913-c968-4e83-ac4f-b4c654a2e7fc",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9dee4903-623a-40ff-930a-67bb9ce6a893",
              "leftValue": "={{ $json.channelTitle }}",
              "rightValue": "PricingCast",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "d3dbf0b6-dd52-4f76-9cd3-ba4403601bda",
              "leftValue": "={{ $json.channelTitle }}",
              "rightValue": "AI Builders",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -880,
        352
      ],
      "id": "b4167a76-75e0-4011-8851-0731dc1a01a5",
      "name": "If - Channel Filter"
    },
    {
      "parameters": {
        "content": "## Transcreve e analisa a transcri√ß√£o",
        "height": 80,
        "width": 976,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -240,
        48
      ],
      "id": "0ad8dbef-0339-4833-9e1e-035ca51d3c01",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Normaliza a sa√≠da para o RAG",
        "height": 80,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1088,
        96
      ],
      "id": "eb12f2be-9d5e-432e-8bd5-ec449b5895f9",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## Transcreve e salva a mensagem",
        "height": 80,
        "width": 752
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1664,
        752
      ],
      "id": "c55f61a3-d0e0-49c7-b4d2-9a382c57e995",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Faz a an√°lise e resumo da transcri√ß√£o",
        "height": 80,
        "width": 608,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -496,
        736
      ],
      "id": "bdf84765-4d9f-44e9-be41-ff92315a15a8",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Envia para o grupo",
        "height": 80,
        "width": 320,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        144,
        736
      ],
      "id": "e8dce093-e38c-486d-9051-c40cd9d489f0",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## Envia para o grupo",
        "height": 80,
        "width": 320,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -32,
        1312
      ],
      "id": "b3104a87-b213-4647-9fe7-1e2432626f78",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## Faz a an√°lise e resumo do OCR",
        "height": 80,
        "width": 784,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -864,
        1264
      ],
      "id": "a0ae8314-2704-47cd-9354-0e964b2404ab",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "## Analisa o conte√∫do da imagem OCR",
        "height": 80,
        "width": 752
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1664,
        1296
      ],
      "id": "3d337a0d-c596-4102-aa82-179722feaf6e",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "## Normaliza a sa√≠da para o RAG",
        "height": 80,
        "width": 448,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        336,
        1312
      ],
      "id": "5e1e4e70-f4a3-4013-a574-6ef9affb7927",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Dados').first().json.variaveis.instance.host }}/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Dados').first().json.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Dados').first().json.variaveis.chat.chatId }}@g.us"
            },
            {
              "name": "text",
              "value": "={{ $json.ai_summary || $('Processar Resumo do V√≠deo').first().json.resumo_video }}"
            },
            {
              "name": "linkPreview",
              "value": "={{false}}"
            },
            {
              "name": "readchat",
              "value": "={{ true }}"
            },
            {
              "name": "replyid",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1632,
        368
      ],
      "id": "461e6bd0-8b68-40ba-bb1e-e18c5034afbc",
      "name": "uazapi - send auto transcribe2",
      "executeOnce": true
    },
    {
      "parameters": {
        "content": "## Envia para o grupo",
        "height": 80,
        "width": 320,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1520,
        240
      ],
      "id": "c169ecc2-143d-4ef9-b7a6-de0bb3e9bb57",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "content": "## Analisa o conte√∫do do documento OCR",
        "height": 80,
        "width": 720
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1664,
        1632
      ],
      "id": "7084eb07-5758-40d5-ab56-2bd52a70b65d",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## Resumo da leitura da imagem",
        "height": 256,
        "width": 592,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -128,
        1872
      ],
      "id": "3cfbb758-53b5-4088-b876-e4c61cad5b07",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "## Faz a an√°lise e resumo do OCR",
        "height": 80,
        "width": 656,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -112,
        1792
      ],
      "id": "6f020701-f754-469d-be63-717e28baf132",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "content": "## Normaliza a sa√≠da para o RAG",
        "height": 80,
        "width": 448,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1392,
        1760
      ],
      "id": "ea7e7eb2-2e30-486b-9523-455fd9bcf52e",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Dados').first().json.variaveis.instance.host }}/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Webhook - Receber Dados').first().json.body.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Webhook - Receber Dados').first().json.body.variaveis.chat.chatId }}@g.us"
            },
            {
              "name": "text",
              "value": "=üé§ *An√°lise do √Åudio Recebido*\n\nüìù *Transcri√ß√£o:*\n{{ $json.transcript }}\n{{ \n  $json.insights_e_actions && $json.insights_e_actions.length > 0 \n    ? \"\\nüí° *Insights e A√ß√µes Identificadas:*\\n\" + \n      $json.insights_e_actions\n        .map(item => `‚Ä¢ ${item.tipo.toUpperCase()}: ${item.conteudo} (${item.prioridade})`)\n        .join('\\n') + '\\n'\n    : '' \n}}\nüìã *Resumo:*\n{{ $json.resumo_executivo }}{{ \n  $json.proximos_passos && $json.proximos_passos.length > 0 \n    ? \"\\n\\nüéØ *Pr√≥ximos Passos:*\\n\" + \n      $json.proximos_passos\n        .map((passo, index) => `${index + 1}. ${passo}`)\n        .join('\\n') \n    : '' \n}}"
            },
            {
              "name": "linkPreview",
              "value": "={{false}}"
            },
            {
              "name": "readchat",
              "value": "={{ true }}"
            },
            {
              "name": "replyid",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        192,
        1072
      ],
      "id": "948b823d-18d5-4d58-90cc-e30ca8aedacb",
      "name": "uazapi - send auto transcribe"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chunk_text",
              "name": "chunk_text",
              "value": "={{ $json.chunk_text_with_header }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "758d4177-78f4-439e-9664-3d88ef449a41",
      "name": "Normalize Chunk Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2112,
        1136
      ]
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "content_type",
              "value": "={{ $json.content_type }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        1312,
        944
      ],
      "id": "080f7939-16de-4f3f-9a46-d847f396cde3",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2384,
        1136
      ],
      "id": "b3e3c815-3a1b-4397-90b4-17a05c21d26a",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "Mlr0yqoxA93FsNLe",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2240,
        1392
      ],
      "id": "5ffd1e77-0582-4955-9707-85563680318b",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "n54CK3O57Rvt7BgD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "textSplittingMode": "custom",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "=title",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.normalized_metadata.title }}"
              },
              {
                "name": "author",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.normalized_metadata.author }}"
              },
              {
                "name": "summary",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.normalized_metadata.summary }}"
              },
              {
                "name": "keywords",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.normalized_metadata.keywords }}"
              },
              {
                "name": "type",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.content_type }}"
              },
              {
                "name": "group",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.group_info.chat_id }}"
              },
              {
                "name": "whatsapp",
                "value": "={{ $('Salvar mensagem e preparar para RAG').item.json.user_info.whatsapp }}"
              },
              {
                "name": "metadata",
                "value": "={{ $('Normalize Chunk Data').item.json.metadata }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        2480,
        1344
      ],
      "id": "d44d552b-e7ce-4672-a447-8c837fb44f62",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "chunkSize": 3000,
        "chunkOverlap": 400,
        "options": {
          "splitCode": "markdown"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2480,
        1472
      ],
      "id": "4d409ab4-63df-4328-8669-3c38208d8d6c",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Salvar mensagem e preparar para RAG').first().json.content_type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f05dc794-eaf2-43c9-85d6-b9715b2b6c8d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Youtube video"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1552,
        1136
      ],
      "id": "60c577a2-25e3-4910-a8b5-1be31ec0e0fc",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsCode": "// Processar chunks do texto para RAG\nconst postgresResult = $('INSERT content_analysis (PostgreSQL)').first().json.result;\nconst originalData = $('Salvar mensagem e preparar para RAG').first().json;\n\n// Extrair o conte√∫do completo\nconst fullContent = originalData.full_content || '';\nconst contentAnalysisId = postgresResult.content_analysis_id;\nconst whatsappMessageId = postgresResult.whatsapp_message_id;\n\n// Extrair informa√ß√µes espec√≠ficas do conte√∫do\nconst contentType = originalData.content_type;\nconst videoTitle = originalData.normalized_metadata?.video_title || originalData.normalized_metadata?.title;\nconst channelName = originalData.normalized_metadata?.channel_name || originalData.normalized_metadata?.author;\nconst mediaUrl = originalData.media_url;\n\n// Fun√ß√£o robusta para dividir texto em chunks com sobreposi√ß√£o\nfunction createChunksWithOverlap(text, maxChunkSize = 1500, overlapSize = 200) {\n  if (!text || text.length === 0) {\n    return [{\n      chunk_text: 'Conte√∫do vazio ou n√£o dispon√≠vel',\n      chunk_index: 0,\n      chunk_size: 0,\n      has_overlap: false\n    }];\n  }\n  \n  const chunks = [];\n  let chunkIndex = 0;\n  let startPosition = 0;\n  \n  // Se o texto √© menor que o limite, retorna como um √∫nico chunk\n  if (text.length <= maxChunkSize) {\n    return [{\n      chunk_text: text,\n      chunk_index: 0,\n      chunk_size: text.length,\n      has_overlap: false\n    }];\n  }\n  \n  while (startPosition < text.length) {\n    // Calcular fim do chunk atual\n    let endPosition = Math.min(startPosition + maxChunkSize, text.length);\n    \n    // Se n√£o √© o √∫ltimo chunk, tentar encontrar uma quebra natural\n    if (endPosition < text.length) {\n      // Procurar por quebra de par√°grafo pr√≥xima\n      let paragraphBreak = text.lastIndexOf('\\n\\n', endPosition);\n      if (paragraphBreak > startPosition && (endPosition - paragraphBreak) < 300) {\n        endPosition = paragraphBreak;\n      } else {\n        // Procurar por quebra de linha\n        let lineBreak = text.lastIndexOf('\\n', endPosition);\n        if (lineBreak > startPosition && (endPosition - lineBreak) < 200) {\n          endPosition = lineBreak;\n        } else {\n          // Procurar por fim de senten√ßa\n          let sentenceBreak = text.lastIndexOf('.', endPosition);\n          if (sentenceBreak > startPosition && (endPosition - sentenceBreak) < 100) {\n            endPosition = sentenceBreak + 1;\n          } else {\n            // Procurar por espa√ßo mais pr√≥ximo\n            let spaceBreak = text.lastIndexOf(' ', endPosition);\n            if (spaceBreak > startPosition) {\n              endPosition = spaceBreak;\n            }\n          }\n        }\n      }\n    }\n    \n    // Extrair o texto do chunk\n    let chunkText = text.substring(startPosition, endPosition).trim();\n    \n    // Adicionar sobreposi√ß√£o do chunk anterior (exceto para o primeiro chunk)\n    let overlapText = '';\n    let hasOverlap = false;\n    \n    if (chunkIndex > 0 && chunks.length > 0) {\n      const previousChunk = chunks[chunks.length - 1].chunk_text;\n      \n      // Pegar √∫ltimas palavras do chunk anterior para sobreposi√ß√£o\n      const words = previousChunk.split(/\\s+/);\n      let overlapWords = [];\n      let currentOverlapSize = 0;\n      \n      // Adicionar palavras do final do chunk anterior at√© atingir o tamanho de overlap\n      for (let i = words.length - 1; i >= 0; i--) {\n        const word = words[i];\n        if (currentOverlapSize + word.length + 1 <= overlapSize) {\n          overlapWords.unshift(word);\n          currentOverlapSize += word.length + 1;\n        } else {\n          break;\n        }\n      }\n      \n      if (overlapWords.length > 0) {\n        overlapText = '...' + overlapWords.join(' ') + '\\n\\n';\n        hasOverlap = true;\n      }\n    }\n    \n    // Texto final do chunk com sobreposi√ß√£o\n    const finalChunkText = overlapText + chunkText;\n    \n    chunks.push({\n      chunk_text: finalChunkText,\n      chunk_index: chunkIndex,\n      chunk_size: finalChunkText.length,\n      has_overlap: hasOverlap,\n      overlap_size: overlapText.length,\n      original_size: chunkText.length\n    });\n    \n    // Calcular pr√≥xima posi√ß√£o inicial\n    if (endPosition >= text.length) {\n      break;\n    }\n    \n    startPosition = endPosition;\n    \n    // Evitar loop infinito\n    if (startPosition === endPosition) {\n      startPosition++;\n    }\n    \n    chunkIndex++;\n  }\n  \n  return chunks;\n}\n\n// Criar cabe√ßalho padr√£o para refer√™ncia\nconst createChunkHeader = (chunkIndex, totalChunks, messageId, analysisId, contentType, videoInfo, hasOverlap) => {\n  let header = `[CHUNK ${chunkIndex + 1}/${totalChunks}]`;\n  \n  // Indicar se tem sobreposi√ß√£o\n  if (hasOverlap) {\n    header += ` [OVERLAP]`;\n  }\n  \n  header += ` [msg_id:${messageId}] [fulltext_origin_id:${analysisId}]\\n`;\n  \n  // Adicionar informa√ß√µes espec√≠ficas do v√≠deo se for conte√∫do de v√≠deo\n  if (contentType === 'video' && videoInfo) {\n    header += `[V√çDEO] ${videoInfo.title}\\n`;\n    header += `[CANAL] ${videoInfo.channel}\\n`;\n    header += `[LINK] ${videoInfo.url}\\n`;\n  }\n  \n  header += `\\n`;\n  return header;\n};\n\n// Processar chunks com sobreposi√ß√£o\nconst chunks = createChunksWithOverlap(fullContent, 1500, 200);\nconst totalChunks = chunks.length;\n\n// Log para debug\nconsole.log(`Texto original: ${fullContent.length} caracteres`);\nconsole.log(`Total de chunks criados: ${totalChunks}`);\nconsole.log(`Chunks com sobreposi√ß√£o: ${chunks.filter(c => c.has_overlap).length}`);\n\n// Preparar informa√ß√µes do v√≠deo para o cabe√ßalho\nconst videoInfo = contentType === 'video' ? {\n  title: videoTitle || 'T√≠tulo n√£o dispon√≠vel',\n  channel: channelName || 'Canal n√£o dispon√≠vel', \n  url: mediaUrl || 'URL n√£o dispon√≠vel'\n} : null;\n\n// Criar array de itens com chunks processados\nconst processedChunks = chunks.map((chunk, index) => {\n  const header = createChunkHeader(index, totalChunks, whatsappMessageId, contentAnalysisId, contentType, videoInfo, chunk.has_overlap);\n  \n  return {\n    chunk_text_with_header: header + chunk.chunk_text,\n    chunk_text_raw: chunk.chunk_text,\n    chunk_index: chunk.chunk_index,\n    chunk_size: chunk.chunk_size,\n    total_chunks: totalChunks,\n    content_analysis_id: contentAnalysisId,\n    whatsapp_message_id: whatsappMessageId,\n    original_content_length: fullContent.length,\n    has_overlap: chunk.has_overlap,\n    overlap_size: chunk.overlap_size || 0,\n    chunk_metadata: {\n      document_type: originalData.document_type,\n      content_type: originalData.content_type,\n      agent_type: originalData.agent_type,\n      processing_date: new Date().toISOString(),\n      group_id: originalData.group_info?.id,\n      user_phone: originalData.user_info?.whatsapp,\n      video_title: videoTitle,\n      channel_name: channelName,\n      media_url: mediaUrl,\n      has_overlap: chunk.has_overlap,\n      overlap_info: chunk.has_overlap ? `${chunk.overlap_size} chars` : null\n    }\n  };\n});\n\nreturn processedChunks;"
      },
      "id": "63009531-b467-46f1-adaf-e30f2dfdf41c",
      "name": "Process Chunks - Youtube",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        1024
      ]
    },
    {
      "parameters": {
        "jsCode": "// Processar chunks do texto para RAG\nconst postgresResult = $('INSERT content_analysis (PostgreSQL)').first().json.result;\nconst originalData = $('Salvar mensagem e preparar para RAG').first().json;\n\n// Extrair o conte√∫do completo\nconst fullContent = originalData.full_content || '';\nconst contentAnalysisId = postgresResult.content_analysis_id;\nconst whatsappMessageId = postgresResult.whatsapp_message_id;\n\n// Fun√ß√£o para dividir texto em chunks\nfunction createChunks(text, maxChunkSize = 1500) {\n  if (!text || text.length === 0) {\n    return [{\n      chunk_text: 'Conte√∫do vazio ou n√£o dispon√≠vel',\n      chunk_index: 0,\n      chunk_size: 0\n    }];\n  }\n  \n  const chunks = [];\n  const sentences = text.split(/[.!?]+\\s+/);\n  let currentChunk = '';\n  let chunkIndex = 0;\n  \n  for (let sentence of sentences) {\n    sentence = sentence.trim();\n    if (!sentence) continue;\n    \n    // Se adicionar a senten√ßa ultrapassar o limite, finaliza o chunk atual\n    if (currentChunk.length + sentence.length + 2 > maxChunkSize && currentChunk.length > 0) {\n      chunks.push({\n        chunk_text: currentChunk.trim(),\n        chunk_index: chunkIndex,\n        chunk_size: currentChunk.trim().length\n      });\n      \n      currentChunk = sentence + '. ';\n      chunkIndex++;\n    } else {\n      currentChunk += sentence + '. ';\n    }\n  }\n  \n  // Adiciona o √∫ltimo chunk se houver conte√∫do\n  if (currentChunk.trim().length > 0) {\n    chunks.push({\n      chunk_text: currentChunk.trim(),\n      chunk_index: chunkIndex,\n      chunk_size: currentChunk.trim().length\n    });\n  }\n  \n  return chunks.length > 0 ? chunks : [{\n    chunk_text: text.substring(0, maxChunkSize),\n    chunk_index: 0,\n    chunk_size: Math.min(text.length, maxChunkSize)\n  }];\n}\n\n// Criar cabe√ßalho padr√£o para refer√™ncia\nconst createChunkHeader = (chunkIndex, totalChunks, messageId, analysisId) => {\n  return `[CHUNK ${chunkIndex + 1}/${totalChunks}] [msg_id:${messageId}] [fulltext_origin_id:${analysisId}]\\n\\n`;\n};\n\n// Processar chunks\nconst chunks = createChunks(fullContent);\nconst totalChunks = chunks.length;\n\n// Criar array de itens com chunks processados\nconst processedChunks = chunks.map((chunk, index) => {\n  const header = createChunkHeader(index, totalChunks, whatsappMessageId, contentAnalysisId);\n  \n  return {\n    chunk_text_with_header: header + chunk.chunk_text,\n    chunk_text_raw: chunk.chunk_text,\n    chunk_index: chunk.chunk_index,\n    chunk_size: chunk.chunk_size,\n    total_chunks: totalChunks,\n    content_analysis_id: contentAnalysisId,\n    whatsapp_message_id: whatsappMessageId,\n    original_content_length: fullContent.length,\n    chunk_metadata: {\n      document_type: originalData.document_type,\n      content_type: originalData.content_type,\n      agent_type: originalData.agent_type,\n      processing_date: new Date().toISOString(),\n      group_id: originalData.group_info?.id,\n      user_phone: originalData.user_info?.whatsapp\n    }\n  };\n});\n\nreturn processedChunks;"
      },
      "id": "4bfa9ee0-9315-4ac6-9d9c-d22cf04979d6",
      "name": "Process Chunks - all media",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        1248
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM youtube_videos \nWHERE youtube_video_id = $1;",
        "options": {
          "queryReplacement": "={{ $('Get - video info').item.json.id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -656,
        352
      ],
      "id": "91b6572a-7e7f-4855-b2fa-6a4f46e74a3f",
      "name": "Get video info",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "=youtube_videos",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "channel_name": "={{ $json.canal_video }}",
            "ai_summary": "={{ $json.resumo_video }}",
            "video_title": "={{ $json.titulo_video }}",
            "youtube_video_id": "={{ $('Get - Video transcription').first().json.data.videoId }}",
            "video_url": "=https://www.youtube.com/watch?v={{ $('Get - Video transcription').first().json.data.videoId }}",
            "full_transcript": "={{ $('Code - corrige sa√≠da').item.json.video.clean_fulltext }}"
          },
          "matchingColumns": [
            "youtube_video_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "channel_name",
              "displayName": "channel_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "video_title",
              "displayName": "video_title",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "video_url",
              "displayName": "video_url",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "youtube_video_id",
              "displayName": "youtube_video_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "full_transcript",
              "displayName": "full_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_summary",
              "displayName": "ai_summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        848,
        224
      ],
      "id": "7fc2f257-9054-4231-a113-de41f0663ed2",
      "name": "Insert - Video on BD",
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Salva o video no BD",
        "height": 80,
        "width": 272,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        768,
        96
      ],
      "id": "89c9d9f5-04cb-4e24-919c-ce5a18ba6fdf",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "content": "## Video j√° est√° salvo?",
        "height": 80,
        "width": 352,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -688,
        224
      ],
      "id": "a3548ce8-b697-4ccd-a2ab-bcda5b24503d",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Dados').first().json.variaveis.instance.host }}/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Dados').first().json.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Dados').first().json.variaveis.chat.chatId }}@g.us"
            },
            {
              "name": "text",
              "value": "={{ $json.mensagem }}"
            },
            {
              "name": "linkPreview",
              "value": "={{false}}"
            },
            {
              "name": "readchat",
              "value": "={{ true }}"
            },
            {
              "name": "replyid",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        1920
      ],
      "id": "3f67ffaf-874f-4ba9-9c6d-1db9c7410f77",
      "name": "uazapi - send auto transcribe3",
      "executeOnce": true
    },
    {
      "parameters": {
        "content": "## Envia para o grupo",
        "height": 80,
        "width": 320,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1040,
        1776
      ],
      "id": "3a3ae370-3081-41e6-b733-71c0986efdcf",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2736,
        1136
      ],
      "id": "298aee22-7d74-4091-8b8e-9571bb6ea443",
      "name": "Edit Fields",
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8337d5f0-91d1-4789-93b7-d24b45164f6d",
              "leftValue": "={{ $('Dados').first().json.grupo.pdf_summary_enabled }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1744,
        1856
      ],
      "id": "8c027551-439b-4f8d-8a38-1574e4f2c8e3",
      "name": "If - PDF analisys = true1",
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "// C√≥digo para n√≥ Code do n8n\n// Dados da transcri√ß√£o (vem do input direto - n√≥ anterior)\nconst captions = $json.data.transcript.captions;\nconst videoId = $json.data.videoId;\n\n// Dados do v√≠deo (n√≥ n√£o conectado - Get - video info retorna array)\nconst videoInfo = $('Get - video info').first().json;\n\n// Filtrar captions v√°lidos\nconst validCaptions = captions.filter(caption => \n  caption.text && caption.text.trim() !== \"No text\"\n);\n\n// Formatar transcri√ß√£o com timestamps\nconst transcript = validCaptions.map(caption => {\n  const totalSeconds = Math.floor(parseFloat(caption.start));\n  const minutes = Math.floor(totalSeconds / 60);\n  const remainingSeconds = totalSeconds % 60;\n  const offset = `${minutes}m${remainingSeconds}s`;\n  const text = caption.text.trim();\n  return `offset: ${offset} - text: ${text}`;\n}).join('\\n');\n\n// Criar transcri√ß√£o limpa (apenas texto, sem timestamps)\nconst clean_fulltext = validCaptions.map(caption => \n  caption.text.trim()\n).join(' ');\n\n// Encontrar maior thumbnail (√© 'thumbnail', n√£o 'thumbnails')\nlet maxThumbnail = \"\";\nif (videoInfo && videoInfo.thumbnail && Array.isArray(videoInfo.thumbnail) && videoInfo.thumbnail.length > 0) {\n  const largest = videoInfo.thumbnail.reduce((max, current) => {\n    return (current.width * current.height) > (max.width * max.height) ? current : max;\n  });\n  maxThumbnail = largest.url;\n}\n\n// Converter dura√ß√£o de segundos para formato \"XmYs\"\nconst lengthSeconds = parseInt(videoInfo.lengthSeconds);\nconst minutes = Math.floor(lengthSeconds / 60);\nconst seconds = lengthSeconds % 60;\nconst formattedLength = `${minutes}m${seconds}s`;\n\nreturn [{\n  video: {\n    id: videoId,\n    title: videoInfo.title || \"No title found\",\n    description: videoInfo.description || \"\",\n    length: formattedLength,\n    channel: {\n      title: videoInfo.channelTitle || \"\",\n      id: videoInfo.channelId || \"\"\n    },\n    transcript: transcript,\n    clean_fulltext: clean_fulltext, // NOVA SA√çDA - texto limpo para BD\n    thumbnail: maxThumbnail\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        224
      ],
      "id": "8b5f7ad1-d8d0-4b3f-bf00-8809acf519cc",
      "name": "Code - corrige sa√≠da"
    },
    {
      "parameters": {
        "content": "## Salvar Rea√ß√£o",
        "height": 80,
        "width": 1088
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1712,
        2432
      ],
      "id": "dc98ecea-2435-410c-a4d4-733283811a87",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "83ffb6a4-0972-4a87-8ca4-184977d1fc64",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -464,
        352
      ],
      "id": "e6e80218-b419-4b3d-93f4-5ea2badc5a19",
      "name": "If - video novo"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Dados').first().json.grupo.transcription_mode }}",
                    "rightValue": "simple_auto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cb064984-aee2-46e8-8286-abc77f64cf94"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "simples_auto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6d061eb5-17f1-4289-add4-9c319c5f72e8",
                    "leftValue": "={{ $('Dados').first().json.grupo.transcription_mode }}",
                    "rightValue": "detailed_auto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "detailed_auto"
            }
          ]
        },
        "options": {
          "fallbackOutput": 0
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -608,
        880
      ],
      "id": "3863ba90-d2bb-4adc-8bb1-58b717d02d28",
      "name": "Simples ou Detalhado?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "gpt-4.1"
            },
            {
              "name": "instructions",
              "value": "=# Especialista em An√°lise de √Åudio e Transcri√ß√µes\n\n## Sua Fun√ß√£o\nVoc√™ √© um especialista em an√°lise de conte√∫do de √°udio, capaz de extrair insights valiosos, identificar a√ß√µes importantes e resumir informa√ß√µes de forma estruturada.\n\n## Instru√ß√µes de An√°lise\n\n### 1. TRANSCRI√á√ÉO\n- Organize e limpe a transcri√ß√£o se necess√°rio\n- Corrija erros √≥bvios de transcri√ß√£o\n- Mantenha o contexto e significado original\n\n### 2. AN√ÅLISE DE INSIGHTS\nIdentifique e extraia:\n- **Pontos principais**: Temas centrais discutidos\n- **Decis√µes tomadas**: Resolu√ß√µes ou conclus√µes\n- **Problemas identificados**: Quest√µes levantadas\n- **Oportunidades**: Possibilidades mencionadas\n- **Informa√ß√µes importantes**: Dados, n√∫meros, datas relevantes\n\n### 3. IDENTIFICA√á√ÉO DE A√á√ïES\nExtraia:\n- **Tarefas espec√≠ficas**: O que precisa ser feito\n- **Respons√°veis**: Quem deve fazer (se mencionado)\n- **Prazos**: Quando deve ser feito (se mencionado)\n- **Pr√≥ximos passos**: Sequ√™ncia de a√ß√µes\n- **Follow-ups**: Acompanhamentos necess√°rios\n\n### 4. FORMATO DE RESPOSTA OBRIGAT√ìRIO\n\nResponda SEMPRE em formato JSON v√°lido:\n\n{\n  \"transcript\": \"Transcri√ß√£o limpa e organizada do √°udio\",\n  \"insights_e_actions\": [\n    {\n      \"tipo\": \"insight\" | \"acao\" | \"decisao\" | \"problema\" | \"oportunidade\",\n      \"conteudo\": \"Descri√ß√£o detalhada\",\n      \"prioridade\": \"alta\" | \"media\" | \"baixa\",\n      \"categoria\": \"reuniao\" | \"projeto\" | \"vendas\" | \"operacao\" | \"estrategia\" | \"outro\"\n    }\n  ],\n  \"resumo_executivo\": \"Resumo de 2-3 frases dos pontos mais importantes\",\n  \"proximos_passos\": [\n    \"A√ß√£o espec√≠fica 1\",\n    \"A√ß√£o espec√≠fica 2\"\n  ]\n}\n\n### 5. DIRETRIZES DE QUALIDADE\n\n- **Seja espec√≠fico**: Evite generalidades\n- **Mantenha contexto**: Preserve informa√ß√µes importantes\n- **Priorize relev√¢ncia**: Foque no que √© acion√°vel\n- **Use linguagem clara**: Evite jarg√µes desnecess√°rios\n- **Seja conciso mas completo**: Informa√ß√£o √∫til sem verbosidade\n\n### 6. TIPOS DE CONTE√öDO\n\n**Para Reuni√µes:**\n- Decis√µes tomadas\n- Tarefas atribu√≠das\n- Problemas discutidos\n- Pr√≥ximas reuni√µes\n\n**Para Calls de Vendas:**\n- Necessidades do cliente\n- Obje√ß√µes levantadas\n- Pr√≥ximos passos\n- Informa√ß√µes sobre decisores\n\n**Para Brainstorming:**\n- Ideias principais\n- Solu√ß√µes propostas\n- A√ß√µes de valida√ß√£o\n- Recursos necess√°rios\n\n### 7. EXEMPLO DE SA√çDA\n\n{\n  \"transcript\": \"Durante a reuni√£o discutimos o projeto X. Jo√£o mencionou que precisamos revisar o or√ßamento at√© sexta-feira. Maria sugeriu uma nova abordagem para o marketing.\",\n  \"insights_e_actions\": [\n    {\n      \"tipo\": \"acao\",\n      \"conteudo\": \"Revisar or√ßamento do projeto X at√© sexta-feira\",\n      \"prioridade\": \"alta\",\n      \"categoria\": \"projeto\"\n    },\n    {\n      \"tipo\": \"insight\",\n      \"conteudo\": \"Nova abordagem de marketing proposta por Maria\",\n      \"prioridade\": \"media\",\n      \"categoria\": \"estrategia\"\n    }\n  ],\n  \"resumo_executivo\": \"Reuni√£o sobre projeto X com defini√ß√£o de revis√£o de or√ßamento e nova proposta de marketing.\",\n  \"proximos_passos\": [\n    \"Revisar or√ßamento at√© sexta\",\n    \"Avaliar proposta de marketing da Maria\"\n  ]\n}\n\n**IMPORTANTE:** Responda APENAS com o JSON v√°lido, sem texto adicional antes ou depois."
            },
            {
              "name": "input",
              "value": "=Analise a seguinte transcri√ß√£o de √°udio e extraia insights e a√ß√µes conforme as instru√ß√µes:\n\n## Transcri√ß√£o do √Åudio:\n{{ $('Transcribe a recording').first().json.text }}\n\n\n---\n\nPor favor, analise e responda no formato JSON especificado."
            },
            {
              "name": "text",
              "value": "={{ {\n      \"format\": {\n        \"type\": \"json_schema\",\n        \"name\": \"analise_reuniao\",\n        \"schema\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"transcript\": {\n        \"type\": \"string\",\n        \"description\": \"Transcri√ß√£o limpa e organizada do √°udio\"\n      },\n      \"insights_e_actions\": {\n        \"type\": \"array\",\n        \"description\": \"Lista de insights, a√ß√µes, decis√µes, problemas ou oportunidades extra√≠das da reuni√£o\",\n        \"items\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"tipo\": {\n              \"type\": \"string\",\n              \"description\": \"Tipo do item identificado\",\n              \"enum\": [\n                \"insight\",\n                \"acao\",\n                \"decisao\",\n                \"problema\",\n                \"oportunidade\"\n              ]\n            },\n            \"conteudo\": {\n              \"type\": \"string\",\n              \"description\": \"Descri√ß√£o detalhada\"\n            },\n            \"prioridade\": {\n              \"type\": \"string\",\n              \"description\": \"N√≠vel de prioridade do item\",\n              \"enum\": [\n                \"alta\",\n                \"media\",\n                \"baixa\"\n              ]\n            },\n            \"categoria\": {\n              \"type\": \"string\",\n              \"description\": \"Categoria de contexto do item\",\n              \"enum\": [\n                \"reuniao\",\n                \"projeto\",\n                \"vendas\",\n                \"operacao\",\n                \"estrategia\",\n                \"outro\"\n              ]\n            }\n          },\n          \"required\": [\n            \"tipo\",\n            \"conteudo\",\n            \"prioridade\",\n            \"categoria\"\n          ],\n          \"additionalProperties\": false\n        }\n      },\n      \"resumo_executivo\": {\n        \"type\": \"string\",\n        \"description\": \"Resumo de 2-3 frases dos pontos mais importantes\"\n      },\n      \"proximos_passos\": {\n        \"type\": \"array\",\n        \"description\": \"Lista de a√ß√µes espec√≠ficas a serem tomadas ap√≥s a reuni√£o\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    },\n    \"required\": [\n      \"transcript\",\n      \"insights_e_actions\",\n      \"resumo_executivo\",\n      \"proximos_passos\"\n    ],\n    \"additionalProperties\": false\n  },\n  \"strict\": true\n}\n    }\n}}"
            }
          ]
        },
        "options": {}
      },
      "id": "8322bc77-541d-43fa-bf3f-37900311dbe9",
      "name": "OpenAI - An√°lise de √Åudio detalhada",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -368,
        976
      ],
      "retryOnFail": true,
      "credentials": {
        "openAiApi": {
          "id": "n54CK3O57Rvt7BgD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Dados').first().json.variaveis.instance.host }}/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Webhook - Receber Dados').first().json.body.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Webhook - Receber Dados').first().json.body.variaveis.chat.chatId }}@g.us"
            },
            {
              "name": "text",
              "value": "=üìùTranscri√ß√£o de √°udio compartilhado por {{ $('Dados').first().json.variaveis.user.name }}:\n__\n{{ $('Transcribe a recording').first().json.text }}\n--\n_Criado por agente de IA e pode conter erros._"
            },
            {
              "name": "linkPreview",
              "value": "={{false}}"
            },
            {
              "name": "readchat",
              "value": "={{ true }}"
            },
            {
              "name": "replyid",
              "value": "={{ $('Dados').first().json.variaveis.message.id }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        192,
        864
      ],
      "id": "d74ad561-0934-43da-8679-5087f7cb9578",
      "name": "uazapi - send auto transcribe4"
    },
    {
      "parameters": {
        "name": "={{ $('Dados').first().json.variaveis.message.media.file_name }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "15uyjT_YzplA5sQfFAkBnj0xAVKY3rBxc",
          "mode": "list",
          "cachedResultName": "02.Grupos What",
          "cachedResultUrl": "https://drive.google.com/drive/folders/15uyjT_YzplA5sQfFAkBnj0xAVKY3rBxc"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -1648,
        2160
      ],
      "id": "59419870-a755-408d-8a82-dd587413255b",
      "name": "Upload file _ Grupos1",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "AqmlN3rwj4iKzJdw",
          "name": "Google Drive account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ===================================================\n-- PROCESSAMENTO COMPLETO DE MENSAGEM WHATSAPP\n-- ===================================================\n\n-- Transa√ß√£o para garantir consist√™ncia\nBEGIN;\n\n-- 1. INSERIR/ATUALIZAR MEMBRO\nWITH upsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES ($2, $3, $3, to_timestamp($4 / 1000.0))\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\n\n-- 2. INSERIR/ATUALIZAR RELACIONAMENTO MEMBRO-GRUPO\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, $1::bigint, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active'\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\n\n-- 3. INSERIR MENSAGEM\ninsert_message AS (\n  INSERT INTO messages (\n    message_id, \n    group_id, \n    member_id, \n    message, \n    type, \n    media_url, \n    media_size, \n    response_to, \n    response_to_id, \n    timestamp\n  )\n  SELECT \n    $5,                                    -- message_id\n    $1::bigint,                           -- group_id\n    um.id,                                -- member_id\n    $6,                                   -- message text\n    LOWER($7),                            -- type (corrigido para lowercase)\n    NULLIF($8, ''),                       -- media_url (null se vazio)\n    CASE WHEN $8 != '' THEN 0 ELSE NULL END, -- media_size placeholder\n    NULLIF($9, ''),                       -- response_to\n    NULLIF($10, ''),                      -- response_to_id\n    to_timestamp($4 / 1000.0)             -- timestamp (corrigido para milissegundos)\n  FROM upsert_member um\n  ON CONFLICT (message_id) DO NOTHING\n  RETURNING id, type, group_id, member_id\n),\n\n-- 4. ATUALIZAR/INSERIR ATIVIDADE DI√ÅRIA\nupsert_activity AS (\n  INSERT INTO members_activity (\n    member_id, \n    group_id, \n    activity_date, \n    message_count, \n    media_count, \n    reaction_count\n  )\n  SELECT \n    um.id,\n    $1::bigint,\n    CURRENT_DATE,\n    CASE WHEN LOWER($7) IN ('text', 'sticker', 'location') THEN 1 ELSE 0 END,\n    CASE WHEN LOWER($7) IN ('audio', 'image', 'video', 'document') THEN 1 ELSE 0 END,\n    CASE WHEN LOWER($7) = 'reaction' THEN 1 ELSE 0 END\n  FROM upsert_member um\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    message_count = members_activity.message_count + EXCLUDED.message_count,\n    media_count = members_activity.media_count + EXCLUDED.media_count,\n    reaction_count = members_activity.reaction_count + EXCLUDED.reaction_count,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, group_id, activity_date, message_count, media_count, reaction_count\n)\n\n-- 5. RETORNAR RESULTADO CONSOLIDADO\nSELECT \n  'success' as status,\n  json_build_object(\n    'member', json_build_object(\n      'id', um.id,\n      'phone', um.phone,\n      'name', um.name\n    ),\n    'message', json_build_object(\n      'id', im.id,\n      'type', im.type,\n      'saved_at', CURRENT_TIMESTAMP\n    ),\n    'activity', json_build_object(\n      'date', ua.activity_date,\n      'messages', ua.message_count,\n      'media', ua.media_count,\n      'reactions', ua.reaction_count\n    ),\n    'processing_info', json_build_object(\n      'timestamp', to_timestamp($4 / 1000.0),\n      'group_id', $1,\n      'message_type', LOWER($7),\n      'has_media', CASE WHEN $8 != '' AND $8 IS NOT NULL THEN true ELSE false END,\n      'is_response', CASE WHEN $10 != '' AND $10 IS NOT NULL THEN true ELSE false END\n    )\n  ) as result\nFROM upsert_member um\nCROSS JOIN insert_message im\nCROSS JOIN upsert_activity ua;\n\nCOMMIT;",
        "options": {
          "queryReplacement": "={{ $json.grupo.id }},{{ $json.variaveis.user.whatsapp }},{{ $json.variaveis.user.name || 'Usu√°rio sem nome' }},{{ $json.variaveis.message.timestamp }},{{ $json.variaveis.message.id }},{{ '\"' + $json.variaveis.message.text + '\"' || null }},{{ $json.variaveis.message.type.toLowerCase() }},{{ $json.variaveis.message.media.url || null }},{{ $json.variaveis.message.responded.text || null }},{{ $json.variaveis.message.responded.id || null }}"
        }
      },
      "id": "1f04166a-7b8e-4c2d-bc52-de8b174abb9c",
      "name": "Salvar Mensagem Texto1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1632,
        512
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa mensagem de texto:\n- Insere/atualiza membro\n- Relaciona membro ao grupo\n- Salva mensagem\n- Atualiza atividade di√°ria"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ===================================================\n-- PROCESSAMENTO COMPLETO DE MENSAGEM WHATSAPP v3\n-- ===================================================\nBEGIN;\n\n-- 1. INSERIR/ATUALIZAR MEMBRO\nWITH upsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES ($2, $3, $3, to_timestamp($4::bigint / 1000.0))\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\n-- 2. INSERIR/ATUALIZAR RELACIONAMENTO MEMBRO-GRUPO\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, $1::bigint, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active',\n    updated_at = CURRENT_TIMESTAMP\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\n-- 3. INSERIR MENSAGEM (com valida√ß√£o de tipo)\ninsert_message AS (\n  INSERT INTO messages (\n    message_id, \n    group_id, \n    member_id, \n    message, \n    type, \n    media_url, \n    media_size, \n    response_to, \n    response_to_id, \n    timestamp\n  )\n  SELECT \n    $5,                                       -- message_id\n    $1::bigint,                              -- group_id\n    um.id,                                   -- member_id\n    $6::text,                                -- message text (com aspas para proteger v√≠rgulas)\n    -- Valida√ß√£o e normaliza√ß√£o do tipo\n    CASE \n      WHEN LOWER($7) IN ('text', 'audio', 'image', 'video', 'document', 'sticker', 'location', 'contact', 'poll', 'reaction') \n      THEN LOWER($7)::text\n      ELSE 'text'::text  -- Default para 'text' se tipo inv√°lido\n    END,\n    NULLIF($8, '')::text,                    -- media_url\n    CASE WHEN $8 != '' THEN 0 ELSE NULL END, -- media_size\n    NULLIF($9, '')::text,                    -- response_to\n    NULLIF($10, '')::text,                   -- response_to_id\n    to_timestamp($4::bigint / 1000.0)        -- timestamp\n  FROM upsert_member um\n  WHERE NOT EXISTS (\n    SELECT 1 FROM messages WHERE message_id = $5\n  )\n  RETURNING id, type, group_id, member_id\n),\n-- 4. ATUALIZAR/INSERIR ATIVIDADE DI√ÅRIA\nupsert_activity AS (\n  INSERT INTO members_activity (\n    member_id, \n    group_id, \n    activity_date, \n    message_count, \n    media_count, \n    reaction_count\n  )\n  SELECT \n    um.id,\n    $1::bigint,\n    (to_timestamp($4::bigint / 1000.0) AT TIME ZONE 'America/Sao_Paulo')::date,\n    CASE \n      WHEN LOWER($7) IN ('text', 'sticker', 'location', 'contact', 'poll') OR LOWER($7) NOT IN ('audio', 'image', 'video', 'document', 'reaction') \n      THEN 1 ELSE 0 \n    END,\n    CASE WHEN LOWER($7) IN ('audio', 'image', 'video', 'document') THEN 1 ELSE 0 END,\n    CASE WHEN LOWER($7) = 'reaction' THEN 1 ELSE 0 END\n  FROM upsert_member um\n  WHERE EXISTS (SELECT 1 FROM insert_message)\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    message_count = members_activity.message_count + EXCLUDED.message_count,\n    media_count = members_activity.media_count + EXCLUDED.media_count,\n    reaction_count = members_activity.reaction_count + EXCLUDED.reaction_count,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, group_id, activity_date, message_count, media_count, reaction_count\n)\n-- 5. RETORNAR RESULTADO CONSOLIDADO\nSELECT \n  CASE \n    WHEN im.id IS NOT NULL THEN 'success'\n    WHEN EXISTS (SELECT 1 FROM messages WHERE message_id = $5) THEN 'duplicate'\n    ELSE 'error'\n  END as status,\n  json_build_object(\n    'member', json_build_object(\n      'id', um.id,\n      'phone', um.phone,\n      'name', um.name\n    ),\n    'message', CASE \n      WHEN im.id IS NOT NULL THEN json_build_object(\n        'id', im.id,\n        'type', im.type,\n        'saved_at', CURRENT_TIMESTAMP\n      )\n      ELSE json_build_object('error', 'Message not inserted')\n    END,\n    'activity', CASE\n      WHEN ua.activity_date IS NOT NULL THEN json_build_object(\n        'date', ua.activity_date,\n        'messages', ua.message_count,\n        'media', ua.media_count,\n        'reactions', ua.reaction_count\n      )\n      ELSE NULL\n    END,\n    'processing_info', json_build_object(\n      'timestamp', to_timestamp($4::bigint / 1000.0),\n      'group_id', $1,\n      'message_type', LOWER($7),\n      'original_type', $7,\n      'has_media', COALESCE($8 != '', false),\n      'is_response', COALESCE($10 != '', false)\n    )\n  ) as result\nFROM upsert_member um\nLEFT JOIN insert_message im ON TRUE\nLEFT JOIN upsert_activity ua ON TRUE;\n\nCOMMIT;",
        "options": {
          "queryReplacement": "={{ $json.grupo.id }},{{ $json.variaveis.user.whatsapp }},{{ $json.variaveis.user.name || 'Usu√°rio sem nome' }},{{ $json.variaveis.message.timestamp }},{{ $json.variaveis.message.id }},{{ '\"' + ($json.variaveis.message.text || '') + '\"' }},{{ $json.variaveis.message.type || 'text' }},{{ $json.variaveis.message.media?.url || '' }},{{ $json.variaveis.message.responded?.text || '' }},{{ $json.variaveis.message.responded?.id || '' }}"
        }
      },
      "id": "36eb42d8-9b87-4859-8995-302764af1826",
      "name": "Salvar Mensagem Texto2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1456,
        512
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa mensagem de texto:\n- Insere/atualiza membro\n- Relaciona membro ao grupo\n- Salva mensagem\n- Atualiza atividade di√°ria"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1056,
        1888
      ],
      "id": "9b4e1ab9-ba6c-458e-9a44-1b566374bdae",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- PROCESSAMENTO DE IMAGEM - VERS√ÉO COM PAR√ÇMETRO JSON √öNICO\nBEGIN;\n-- Buscar o ID interno do grupo\nWITH group_lookup AS (\n  SELECT id as group_id_internal\n  FROM groups \n  WHERE chat_id = ($1::jsonb->>'chat_id')\n),\nupsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES (\n    $1::jsonb->>'user_phone',\n    $1::jsonb->>'user_name',\n    $1::jsonb->>'user_name',\n    to_timestamp(($1::jsonb->>'timestamp')::bigint / 1000)\n  )\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, gl.group_id_internal, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active'\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\ninsert_message AS (\n  INSERT INTO messages (\n    message_id, group_id, member_id, message, type, \n    media_url, response_to, response_to_id, timestamp\n  )\n  SELECT \n    $1::jsonb->>'message_id',\n    gl.group_id_internal,\n    um.id,\n    CASE \n      WHEN COALESCE($1::jsonb->>'message_text', '') = '' THEN '[Imagem]'\n      ELSE $1::jsonb->>'message_text'\n    END,\n    LOWER($1::jsonb->>'message_type'),\n    NULLIF($1::jsonb->>'media_url', ''),\n    NULLIF($1::jsonb->>'response_to_text', ''),\n    NULLIF($1::jsonb->>'response_to_id', ''),\n    to_timestamp(($1::jsonb->>'timestamp')::bigint / 1000)\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (message_id) DO NOTHING\n  RETURNING id, type, message\n),\nupsert_activity AS (\n  INSERT INTO members_activity (member_id, group_id, activity_date, message_count, media_count)\n  SELECT um.id, gl.group_id_internal, CURRENT_DATE, 0, 1\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    media_count = members_activity.media_count + 1,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, media_count\n),\n-- CRIAR ENTRADA PARA AN√ÅLISE DE CONTE√öDO (IMAGEM)\ninsert_content_analysis AS (\n  INSERT INTO content_analysis (\n    message_id, \n    content_type, \n    processing_status,\n    summary,\n    media_url\n  )\n  SELECT \n    im.id, \n    'image', \n    'completed',\n    $1::jsonb->>'message_text',\n    $1::jsonb->>'media_url'\n  FROM insert_message im\n  WHERE ($1::jsonb->>'process_analysis')::boolean = true\n  RETURNING id, processing_status\n)\nSELECT \n  'image_processed' as status,\n  json_build_object(\n    'member_id', um.id,\n    'member_name', um.name,\n    'group_id_internal', gl.group_id_internal,\n    'message_id', im.id,\n    'message_content', im.message,\n    'message_type', im.type,\n    'media_count', ua.media_count,\n    'analysis_saved', CASE WHEN ($1::jsonb->>'process_analysis')::boolean THEN true ELSE false END\n  ) as result\nFROM upsert_member um\nCROSS JOIN group_lookup gl\nCROSS JOIN insert_message im\nCROSS JOIN upsert_activity ua;\nCOMMIT;",
        "options": {
          "queryReplacement": "={{\n  JSON.stringify({\n    \"chat_id\": $('Dados').item.json.variaveis.chat.chatId,\n    \"user_phone\": $('Dados').item.json.variaveis.user.whatsapp,\n    \"user_name\": $('Dados').item.json.variaveis.user.name || 'Usu√°rio sem nome',\n    \"timestamp\": $('Dados').item.json.variaveis.message.timestamp,\n    \"message_id\": $('Dados').item.json.variaveis.message.id,\n    \"message_text\": $('Processar Resposta da IA2').item.json.analise_resultado || '',\n    \"message_type\": $('Dados').item.json.variaveis.message.type,\n    \"media_url\": $('Uazapi - get aimage url').item.json.fileURL || '',\n    \"response_to_text\": $('Dados').item.json.variaveis.message.responded?.text || null,\n    \"response_to_id\": $('Dados').item.json.variaveis.message.responded?.id || null,\n    \"process_analysis\": true\n  })\n}}"
        }
      },
      "id": "0697f61c-fbdd-405d-9641-2914a31a75bc",
      "name": "Salvar Mensagem Imagem",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        64,
        1616
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa √°udio:\n- Salva como m√≠dia\n- Queue para transcri√ß√£o se habilitado\n- Atualiza contador de m√≠dia"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "12f12aa7-1d01-4959-8391-1af2165bbad9",
              "leftValue": "={{ $('Processar Resposta - An√°lise PDF').first().json.analise_pdf_completa.status }}",
              "rightValue": "aceito",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        912,
        1936
      ],
      "id": "07201f08-6a71-42c5-af68-46f69380b3c3",
      "name": "If - aprovado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "gpt-4.1"
            },
            {
              "name": "instructions",
              "value": "=# Especialista em An√°lise de √Åudio e Transcri√ß√µes\n\n## Sua Fun√ß√£o\nVoc√™ √© um especialista em an√°lise de conte√∫do de √°udio, capaz de extrair insights valiosos, identificar a√ß√µes importantes e resumir informa√ß√µes de forma estruturada.\n\n## Instru√ß√µes de An√°lise\n\n### 1. TRANSCRI√á√ÉO\n- Organize e limpe a transcri√ß√£o se necess√°rio\n- Corrija erros √≥bvios de transcri√ß√£o\n- Mantenha o contexto e significado original\n\n### 2. AN√ÅLISE DE INSIGHTS\nIdentifique e extraia:\n- **Pontos principais**: Temas centrais discutidos\n- **Decis√µes tomadas**: Resolu√ß√µes ou conclus√µes\n- **Problemas identificados**: Quest√µes levantadas\n- **Oportunidades**: Possibilidades mencionadas\n- **Informa√ß√µes importantes**: Dados, n√∫meros, datas relevantes\n\n### 3. IDENTIFICA√á√ÉO DE A√á√ïES\nExtraia:\n- **Tarefas espec√≠ficas**: O que precisa ser feito\n- **Respons√°veis**: Quem deve fazer (se mencionado)\n- **Prazos**: Quando deve ser feito (se mencionado)\n- **Pr√≥ximos passos**: Sequ√™ncia de a√ß√µes\n- **Follow-ups**: Acompanhamentos necess√°rios\n\n### 4. FORMATO DE RESPOSTA OBRIGAT√ìRIO\n\nResponda SEMPRE em formato JSON v√°lido:\n\n{\n  \"transcript\": \"Transcri√ß√£o limpa e organizada do √°udio\",\n  \"insights_e_actions\": [\n    {\n      \"tipo\": \"insight\" | \"acao\" | \"decisao\" | \"problema\" | \"oportunidade\",\n      \"conteudo\": \"Descri√ß√£o detalhada\",\n      \"prioridade\": \"alta\" | \"media\" | \"baixa\",\n      \"categoria\": \"reuniao\" | \"projeto\" | \"vendas\" | \"operacao\" | \"estrategia\" | \"outro\"\n    }\n  ],\n  \"resumo_executivo\": \"Resumo de 2-3 frases dos pontos mais importantes\",\n  \"proximos_passos\": [\n    \"A√ß√£o espec√≠fica 1\",\n    \"A√ß√£o espec√≠fica 2\"\n  ]\n}\n\n### 5. DIRETRIZES DE QUALIDADE\n\n- **Seja espec√≠fico**: Evite generalidades\n- **Mantenha contexto**: Preserve informa√ß√µes importantes\n- **Priorize relev√¢ncia**: Foque no que √© acion√°vel\n- **Use linguagem clara**: Evite jarg√µes desnecess√°rios\n- **Seja conciso mas completo**: Informa√ß√£o √∫til sem verbosidade\n\n### 6. TIPOS DE CONTE√öDO\n\n**Para Reuni√µes:**\n- Decis√µes tomadas\n- Tarefas atribu√≠das\n- Problemas discutidos\n- Pr√≥ximas reuni√µes\n\n**Para Calls de Vendas:**\n- Necessidades do cliente\n- Obje√ß√µes levantadas\n- Pr√≥ximos passos\n- Informa√ß√µes sobre decisores\n\n**Para Brainstorming:**\n- Ideias principais\n- Solu√ß√µes propostas\n- A√ß√µes de valida√ß√£o\n- Recursos necess√°rios\n\n### 7. EXEMPLO DE SA√çDA\n\n{\n  \"transcript\": \"Durante a reuni√£o discutimos o projeto X. Jo√£o mencionou que precisamos revisar o or√ßamento at√© sexta-feira. Maria sugeriu uma nova abordagem para o marketing.\",\n  \"insights_e_actions\": [\n    {\n      \"tipo\": \"acao\",\n      \"conteudo\": \"Revisar or√ßamento do projeto X at√© sexta-feira\",\n      \"prioridade\": \"alta\",\n      \"categoria\": \"projeto\"\n    },\n    {\n      \"tipo\": \"insight\",\n      \"conteudo\": \"Nova abordagem de marketing proposta por Maria\",\n      \"prioridade\": \"media\",\n      \"categoria\": \"estrategia\"\n    }\n  ],\n  \"resumo_executivo\": \"Reuni√£o sobre projeto X com defini√ß√£o de revis√£o de or√ßamento e nova proposta de marketing.\",\n  \"proximos_passos\": [\n    \"Revisar or√ßamento at√© sexta\",\n    \"Avaliar proposta de marketing da Maria\"\n  ]\n}\n\n**IMPORTANTE:** Responda APENAS com o JSON v√°lido, sem texto adicional antes ou depois."
            },
            {
              "name": "input",
              "value": "=Analise a seguinte transcri√ß√£o de √°udio e extraia insights e a√ß√µes conforme as instru√ß√µes:\n\n## Transcri√ß√£o do √Åudio:\n{{ $('Transcribe a recording').first().json.text }}\n\n\n---\n\nPor favor, analise e responda no formato JSON especificado."
            },
            {
              "name": "text",
              "value": "={{ {\n      \"format\": {\n        \"type\": \"json_schema\",\n        \"name\": \"analise_reuniao\",\n        \"schema\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"transcript\": {\n        \"type\": \"string\",\n        \"description\": \"Transcri√ß√£o limpa e organizada do √°udio\"\n      },\n      \"insights_e_actions\": {\n        \"type\": \"array\",\n        \"description\": \"Lista de insights, a√ß√µes, decis√µes, problemas ou oportunidades extra√≠das da reuni√£o\",\n        \"items\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"tipo\": {\n              \"type\": \"string\",\n              \"description\": \"Tipo do item identificado\",\n              \"enum\": [\n                \"insight\",\n                \"acao\",\n                \"decisao\",\n                \"problema\",\n                \"oportunidade\"\n              ]\n            },\n            \"conteudo\": {\n              \"type\": \"string\",\n              \"description\": \"Descri√ß√£o detalhada\"\n            },\n            \"prioridade\": {\n              \"type\": \"string\",\n              \"description\": \"N√≠vel de prioridade do item\",\n              \"enum\": [\n                \"alta\",\n                \"media\",\n                \"baixa\"\n              ]\n            },\n            \"categoria\": {\n              \"type\": \"string\",\n              \"description\": \"Categoria de contexto do item\",\n              \"enum\": [\n                \"reuniao\",\n                \"projeto\",\n                \"vendas\",\n                \"operacao\",\n                \"estrategia\",\n                \"outro\"\n              ]\n            }\n          },\n          \"required\": [\n            \"tipo\",\n            \"conteudo\",\n            \"prioridade\",\n            \"categoria\"\n          ],\n          \"additionalProperties\": false\n        }\n      },\n      \"resumo_executivo\": {\n        \"type\": \"string\",\n        \"description\": \"Resumo de 2-3 frases dos pontos mais importantes\"\n      },\n      \"proximos_passos\": {\n        \"type\": \"array\",\n        \"description\": \"Lista de a√ß√µes espec√≠ficas a serem tomadas ap√≥s a reuni√£o\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    },\n    \"required\": [\n      \"transcript\",\n      \"insights_e_actions\",\n      \"resumo_executivo\",\n      \"proximos_passos\"\n    ],\n    \"additionalProperties\": false\n  },\n  \"strict\": true\n}\n    }\n}}"
            }
          ]
        },
        "options": {}
      },
      "id": "2c66b48e-0ab7-4fbe-ad0e-7c7bc45e0155",
      "name": "OpenAI - An√°lise de √Åudio detalhada1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        512,
        864
      ],
      "retryOnFail": true,
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Extrai e formata a an√°lise de PDF para envio no WhatsApp\n// Para usar no n8n: cole este c√≥digo no n√≥ Code ap√≥s a resposta da API OpenAI\n\nfunction formatarMensagemWhatsApp() {\n    try {\n        // Extrai o JSON da resposta da API OpenAI\n        const responseData = $('OpenAI - An√°lise PDF1').item.json;\n        \n        // Caminho para o texto da an√°lise: output[0].content[0].text\n        let analiseTexto;\n        \n        if (responseData.output && responseData.output[0] && responseData.output[0].content && responseData.output[0].content[0]) {\n            analiseTexto = responseData.output[0].content[0].text;\n        } else {\n            throw new Error(\"Estrutura de resposta da API n√£o encontrada\");\n        }\n        \n        // Parse do JSON da an√°lise\n        const analise = JSON.parse(analiseTexto);\n        \n        // Verifica se o documento foi aceito ou rejeitado\n        if (analise.status !== \"aceito\") {\n            return formatarDocumentoRejeitado(analise);\n        }\n        \n        // Formata mensagem completa para documento aceito\n        return formatarDocumentoAceito(analise);\n        \n    } catch (error) {\n        return `‚ùå *ERRO NO PROCESSAMENTO*\\n\\nN√£o foi poss√≠vel processar a an√°lise do documento.\\n\\n*Detalhes do erro:* ${error.message}`;\n    }\n}\n\nfunction formatarDocumentoRejeitado(analise) {\n    return `‚ùå *DOCUMENTO N√ÉO ANALISADO*\\n` +\n           `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n` +\n           `üìÑ *Tipo identificado:* ${analise.tipo_documento.replace('_', ' ')}\\n\\n` +\n           `‚ö†Ô∏è *Motivo:* ${analise.resposta_whatsapp.texto_formatado}\\n\\n` +\n           `‚ÑπÔ∏è *Este tipo de documento n√£o √© analisado automaticamente pelo sistema.*`;\n}\n\nfunction formatarDocumentoAceito(analise) {\n    const { resposta_whatsapp, analise_detalhada, filtros_aplicaveis } = analise;\n    \n    let mensagem = \"\";\n    \n    // Cabe√ßalho principal\n    mensagem += `${resposta_whatsapp.emoji_categoria} *AN√ÅLISE COMPLETA DE DOCUMENTO*\\n`;\n    mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n    \n    // T√≠tulo e autor\n    mensagem += `üìÑ *T√çTULO:*\\n${analise_detalhada.titulo}\\n\\n`;\n    mensagem += `üë§ *AUTOR(ES):*\\n${analise_detalhada.autor}\\n\\n`;\n    \n    // Resumo executivo\n    mensagem += `üìã *RESUMO EXECUTIVO:*\\n${analise_detalhada.resumo_executivo}\\n\\n`;\n    \n    // Insights principais\n    mensagem += `üí° *PRINCIPAIS INSIGHTS:*\\n`;\n    analise_detalhada.insights_principais.forEach((insight, index) => {\n        mensagem += `${index + 1}. ${insight}\\n`;\n    });\n    mensagem += `\\n`;\n    \n    // Dados relevantes\n    mensagem += `üìä *DADOS E N√öMEROS IMPORTANTES:*\\n`;\n    analise_detalhada.dados_relevantes.forEach((dado) => {\n        mensagem += `‚Ä¢ ${dado}\\n`;\n    });\n    mensagem += `\\n`;\n    \n    // Conclus√µes e recomenda√ß√µes\n    mensagem += `üéØ *CONCLUS√ïES E RECOMENDA√á√ïES:*\\n`;\n    analise_detalhada.conclusoes.forEach((conclusao, index) => {\n        mensagem += `${index + 1}. ${conclusao}\\n`;\n    });\n    mensagem += `\\n`;\n    \n    // Informa√ß√µes t√©cnicas\n    mensagem += `‚ÑπÔ∏è *INFORMA√á√ïES T√âCNICAS:*\\n`;\n    mensagem += `‚Ä¢ *Tipo:* ${analise.tipo_documento.replace('_', ' ')}\\n`;\n    mensagem += `‚Ä¢ *Complexidade:* ${filtros_aplicaveis.complexidade.toUpperCase()}\\n`;\n    mensagem += `‚Ä¢ *Tamanho:* ${filtros_aplicaveis.tamanho.toUpperCase()}\\n`;\n    mensagem += `‚Ä¢ *Confian√ßa da classifica√ß√£o:* ${(analise.confianca_classificacao * 100).toFixed(0)}%\\n\\n`;\n    \n    // Tags\n    if (filtros_aplicaveis.tags_automaticas && filtros_aplicaveis.tags_automaticas.length > 0) {\n        mensagem += `üè∑Ô∏è *TAGS:*\\n`;\n        mensagem += filtros_aplicaveis.tags_automaticas\n            .map(tag => `#${tag.replace(/\\s+/g, '')}`)\n            .join(' ');\n    }\n    \n    return mensagem;\n}\n\n// Executa a fun√ß√£o e retorna o resultado\nconst mensagemFormatada = formatarMensagemWhatsApp();\n\n// Retorna o resultado no formato que o n8n espera\nreturn [{\n    json: {\n        mensagem: mensagemFormatada,\n        timestamp: new Date().toISOString(),\n        status: \"formatado\"\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        1936
      ],
      "id": "b790268d-f737-413d-b842-b262184cfddc",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -304,
        1936
      ],
      "id": "3a986771-a655-4252-b25b-7c71afd21803",
      "name": "Merge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4d22e13e-f9e1-45a2-b451-86f3b026b18c",
              "leftValue": "={{ $json.numpages }}",
              "rightValue": 20,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -864,
        1888
      ],
      "id": "8435ab70-9a59-49c4-bb61-521ba2621d4f",
      "name": "If"
    },
    {
      "parameters": {
        "url": "={{ $('Uazapi - get aimage url1').item.json.fileURL }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -688,
        1792
      ],
      "id": "39812f9d-0d8a-43fa-aa29-5222b98146e7",
      "name": "download - image3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- PROCESSAMENTO DE IMAGEM - VERS√ÉO COM PAR√ÇMETRO JSON √öNICO\nBEGIN;\n-- Buscar o ID interno do grupo\nWITH group_lookup AS (\n  SELECT id as group_id_internal\n  FROM groups \n  WHERE chat_id = ($1::jsonb->>'chat_id')\n),\nupsert_member AS (\n  INSERT INTO members (phone, name, profile_name, last_seen)\n  VALUES (\n    $1::jsonb->>'user_phone',\n    $1::jsonb->>'user_name',\n    $1::jsonb->>'user_name',\n    to_timestamp(($1::jsonb->>'timestamp')::bigint / 1000)\n  )\n  ON CONFLICT (phone) \n  DO UPDATE SET \n    name = EXCLUDED.name,\n    profile_name = EXCLUDED.profile_name,\n    last_seen = EXCLUDED.last_seen,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING id, phone, name\n),\nupsert_member_group AS (\n  INSERT INTO members_groups (member_id, group_id, joined_at)\n  SELECT um.id, gl.group_id_internal, CURRENT_TIMESTAMP\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (member_id, group_id)\n  DO UPDATE SET \n    status = 'active'\n  WHERE members_groups.status != 'active'\n  RETURNING member_id, group_id\n),\ninsert_message AS (\n  INSERT INTO messages (\n    message_id, group_id, member_id, message, type, \n    media_url, response_to, response_to_id, timestamp\n  )\n  SELECT \n    $1::jsonb->>'message_id',\n    gl.group_id_internal,\n    um.id,\n    CASE \n      WHEN COALESCE($1::jsonb->>'message_text', '') = '' THEN '[Imagem]'\n      ELSE $1::jsonb->>'message_text'\n    END,\n    LOWER($1::jsonb->>'message_type'),\n    NULLIF($1::jsonb->>'media_url', ''),\n    NULLIF($1::jsonb->>'response_to_text', ''),\n    NULLIF($1::jsonb->>'response_to_id', ''),\n    to_timestamp(($1::jsonb->>'timestamp')::bigint / 1000)\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (message_id) DO NOTHING\n  RETURNING id, type, message\n),\nupsert_activity AS (\n  INSERT INTO members_activity (member_id, group_id, activity_date, message_count, media_count)\n  SELECT um.id, gl.group_id_internal, CURRENT_DATE, 0, 1\n  FROM upsert_member um\n  CROSS JOIN group_lookup gl\n  ON CONFLICT (member_id, group_id, activity_date)\n  DO UPDATE SET \n    media_count = members_activity.media_count + 1,\n    updated_at = CURRENT_TIMESTAMP\n  RETURNING member_id, media_count\n),\n-- CRIAR ENTRADA PARA AN√ÅLISE DE CONTE√öDO (IMAGEM)\ninsert_content_analysis AS (\n  INSERT INTO content_analysis (\n    message_id, \n    content_type, \n    processing_status,\n    summary,\n    media_url\n  )\n  SELECT \n    im.id, \n    'image', \n    'completed',\n    $1::jsonb->>'message_text',\n    $1::jsonb->>'media_url'\n  FROM insert_message im\n  WHERE ($1::jsonb->>'process_analysis')::boolean = true\n  RETURNING id, processing_status\n)\nSELECT \n  'image_processed' as status,\n  json_build_object(\n    'member_id', um.id,\n    'member_name', um.name,\n    'group_id_internal', gl.group_id_internal,\n    'message_id', im.id,\n    'message_content', im.message,\n    'message_type', im.type,\n    'media_count', ua.media_count,\n    'analysis_saved', CASE WHEN ($1::jsonb->>'process_analysis')::boolean THEN true ELSE false END\n  ) as result\nFROM upsert_member um\nCROSS JOIN group_lookup gl\nCROSS JOIN insert_message im\nCROSS JOIN upsert_activity ua;\nCOMMIT;",
        "options": {
          "queryReplacement": "={{\n  JSON.stringify({\n    \"chat_id\": $('Dados').first().json.variaveis.chat.chatId,\n    \"user_phone\": $('Dados').first().json.variaveis.user.whatsapp,\n    \"user_name\": $('Dados').first().json.variaveis.user.name || 'Usu√°rio sem nome',\n    \"timestamp\": $('Dados').first().json.variaveis.message.timestamp,\n    \"message_id\": $('Dados').first().json.variaveis.message.id,\n    \"message_text\": $('Code').first().json.mensagem || '',\n    \"message_type\": $('Dados').first().json.variaveis.message.type,\n    \"media_url\": $('Uazapi - get aimage url1').first().json.fileURL || '',\n    \"response_to_text\": $('Dados').first().json.variaveis.message.responded?.text || null,\n    \"response_to_id\": $('Dados').first().json.variaveis.message.responded?.id || null,\n    \"process_analysis\": true\n  })\n}}"
        }
      },
      "id": "2ce3bba5-56df-46b9-a8a3-77910106b5d3",
      "name": "Salvar Mensagem Imagem1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        912,
        2112
      ],
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      },
      "notes": "Processa √°udio:\n- Salva como m√≠dia\n- Queue para transcri√ß√£o se habilitado\n- Atualiza contador de m√≠dia"
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -1056,
        1728
      ],
      "id": "8f001c7b-548c-4fa6-aaf8-c51688b9f0ab",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "S4ffC5mOksSVCHaN",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Dados').item.json.variaveis.instance.host }}/chat/details",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "token",
              "value": "={{ $('Dados').item.json.variaveis.instance.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Dados').item.json.variaveis.chat.chatId }}@g.us"
            },
            {
              "name": "preview",
              "value": "={{false}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2400,
        1904
      ],
      "id": "38371c42-2677-4e9a-86ca-d2151fa298ab",
      "name": "Uazapi - get group picture",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "groups",
          "mode": "list",
          "cachedResultName": "groups"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.wa_chatid.split(\"@\")[0] }}",
            "name": "={{ $json.name }}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "auto_transcription_enabled",
              "displayName": "auto_transcription_enabled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pdf_summary_enabled",
              "displayName": "pdf_summary_enabled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "link_summary_enabled",
              "displayName": "link_summary_enabled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "daily_summary_enabled",
              "displayName": "daily_summary_enabled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "youtube_auto_transcript_enabled",
              "displayName": "youtube_auto_transcript_enabled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "auto_send_summary_enabled",
              "displayName": "auto_send_summary_enabled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary_destination_type",
              "displayName": "summary_destination_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary_destination_value",
              "displayName": "summary_destination_value",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "summary_send_time",
              "displayName": "summary_send_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "transcription_mode",
              "displayName": "transcription_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "disabled",
                  "value": "disabled"
                },
                {
                  "name": "simple_auto",
                  "value": "simple_auto"
                },
                {
                  "name": "detailed_auto",
                  "value": "detailed_auto"
                },
                {
                  "name": "command_only",
                  "value": "command_only"
                }
              ],
              "removed": true
            },
            {
              "id": "instance_id",
              "displayName": "instance_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2192,
        1904
      ],
      "id": "56550b93-929d-41d9-9b2c-7952bed018f7",
      "name": "Update rows in a table",
      "credentials": {
        "postgres": {
          "id": "pJxCPVxdffoOYTKt",
          "name": "Postgres - m7 growth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d2834e0a-d4f2-4d74-9f9c-0c5f5644a6de",
              "leftValue": "={{ $('Dados').item.json.variaveis.user.whatsapp }}",
              "rightValue": "5511979714123",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1136,
        2128
      ],
      "id": "4155ff0d-f6fb-43f9-be9c-a40b0af30f98",
      "name": "If_Quem enviou3"
    },
    {
      "parameters": {
        "name": "={{ $('Switch1').item.json.body.data.content.media.metadata.fileName }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "15uyjT_YzplA5sQfFAkBnj0xAVKY3rBxc",
          "mode": "list",
          "cachedResultName": "02.Grupos What",
          "cachedResultUrl": "https://drive.google.com/drive/folders/15uyjT_YzplA5sQfFAkBnj0xAVKY3rBxc"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -736,
        2256
      ],
      "id": "026673cb-c00f-4824-a9d7-3f8fe44ba098",
      "name": "Upload file _ Grupos",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "AqmlN3rwj4iKzJdw",
          "name": "Google Drive account 2"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ $('Switch1').item.json.body.data.content.media.metadata.fileName }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1pY_98LeyuDlB423LG3iU4QuFtBTve1h3",
          "mode": "list",
          "cachedResultName": "01. Fabio",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1pY_98LeyuDlB423LG3iU4QuFtBTve1h3"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -736,
        2048
      ],
      "id": "52a6cbf2-3f98-4e4e-a3a8-236ca60d37b4",
      "name": "Upload _ ADM Enviou",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "aLI9aMncP7obkvZq",
          "name": "Google Drive account"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Receber Dados": {
      "main": [
        [
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - Tipo de Mensagem": {
      "main": [
        [
          {
            "node": "Salvar Mensagem Texto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Uazapi - get audio url",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If - PDF analisys = true",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "If - PDF analisys = true1",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [],
        [
          {
            "node": "Salvar Rea√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Mensagem Texto": {
      "main": [
        [
          {
            "node": "Resultado Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Mensagem √Åudio": {
      "main": [
        [
          {
            "node": "If - Auto transcribe = True",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Uazapi - get audio url": {
      "main": [
        [
          {
            "node": "download - audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Salvar Mensagem √Åudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "Switch - Tipo de Mensagem",
            "type": "main",
            "index": 0
          },
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Uazapi - get group picture",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resposta da IA": {
      "main": [
        [
          {
            "node": "uazapi - send auto transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Uazapi - get aimage url": {
      "main": [
        [
          {
            "node": "download - image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "download - audio": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "download - image": {
      "main": [
        [
          {
            "node": "Extract text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract text": {
      "main": [
        [
          {
            "node": "Extraction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Prompts para An√°lise2": {
      "main": [
        [
          {
            "node": "OpenAI - An√°lise de Imagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - An√°lise de Imagem1": {
      "main": [
        [
          {
            "node": "Processar Resposta da IA2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resposta da IA2": {
      "main": [
        [
          {
            "node": "Salvar Mensagem Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "uazapi - send auto transcribe1": {
      "main": [
        [
          {
            "node": "Normalizar Dados da Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - Auto transcribe = True": {
      "main": [
        [
          {
            "node": "Simples ou Detalhado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resultado Final": {
      "main": [
        [
          {
            "node": "If - have youtube link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - have youtube link": {
      "main": [
        [
          {
            "node": "Get - video info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get - video info": {
      "main": [
        [
          {
            "node": "If - Channel Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get - Video transcription": {
      "main": [
        [
          {
            "node": "Code - corrige sa√≠da",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Prompts para An√°lise de V√≠deo": {
      "main": [
        [
          {
            "node": "OpenAI - An√°lise de V√≠deo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - An√°lise de V√≠deo": {
      "main": [
        [
          {
            "node": "Processar Resumo do V√≠deo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resumo do V√≠deo": {
      "main": [
        [
          {
            "node": "Insert - Video on BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Uazapi - get aimage url1": {
      "main": [
        [
          {
            "node": "download - image1",
            "type": "main",
            "index": 0
          },
          {
            "node": "If_Quem enviou3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "download - image1": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - An√°lise PDF1": {
      "main": [
        [
          {
            "node": "Processar Resposta - An√°lise PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resposta - An√°lise PDF": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INSERT content_analysis (PostgreSQL)": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar mensagem e preparar para RAG": {
      "main": [
        [
          {
            "node": "INSERT content_analysis (PostgreSQL)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DOC Reader": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Prompts - An√°lise DOC": {
      "main": [
        [
          {
            "node": "OpenAI - An√°lise PDF1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Dados do V√≠deo": {
      "main": [
        [
          {
            "node": "Execute RAG Insert Workflow - V√≠deo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraction": {
      "main": [
        [
          {
            "node": "Preparar Prompts para An√°lise2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Dados da Imagem": {
      "main": [
        [
          {
            "node": "Execute RAG Insert Workflow - Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - Channel Filter": {
      "main": [
        [
          {
            "node": "Get video info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute RAG Insert Workflow - V√≠deo": {
      "main": [
        [
          {
            "node": "uazapi - send auto transcribe2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Chunk Data": {
      "main": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Process Chunks - Youtube",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Chunks - all media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Chunks - Youtube": {
      "main": [
        [
          {
            "node": "Normalize Chunk Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Chunks - all media": {
      "main": [
        [
          {
            "node": "Normalize Chunk Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get video info": {
      "main": [
        [
          {
            "node": "If - video novo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert - Video on BD": {
      "main": [
        [
          {
            "node": "Normalizar Dados do V√≠deo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - PDF analisys = true1": {
      "main": [
        [
          {
            "node": "Uazapi - get aimage url1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - corrige sa√≠da": {
      "main": [
        [
          {
            "node": "Preparar Prompts para An√°lise de V√≠deo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - video novo": {
      "main": [
        [
          {
            "node": "Get - Video transcription",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "uazapi - send auto transcribe2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simples ou Detalhado?": {
      "main": [
        [
          {
            "node": "uazapi - send auto transcribe4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OpenAI - An√°lise de √Åudio detalhada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - An√°lise de √Åudio detalhada": {
      "main": [
        [
          {
            "node": "Processar Resposta da IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If - aprovado": {
      "main": [
        [
          {
            "node": "uazapi - send auto transcribe3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "uazapi - send auto transcribe3": {
      "main": [
        [
          {
            "node": "Execute RAG insert Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "If - aprovado",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar Mensagem Imagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Preparar Prompts - An√°lise DOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "download - image3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "download - image3": {
      "main": [
        [
          {
            "node": "DOC Reader",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Uazapi - get group picture": {
      "main": [
        [
          {
            "node": "Update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If_Quem enviou3": {
      "main": [
        [
          {
            "node": "Upload _ ADM Enviou",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Upload file _ Grupos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e8760eeb-8475-4825-bd81-dfc48de7f0e1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "00000000000000000000000000000000000000000000000000000000000000000"
  },
  "id": "7KHUAXuTh186zhIc",
  "tags": []
}